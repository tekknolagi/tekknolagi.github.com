---
title: "Compiling a Lisp: Instruction encoding interlude"
layout: post
date: 2020-10-18 17:00:00 PDT
description: In which we learn a little about x86-64 instruction encoding
---

<span data-nosnippet>
*[first]({% link _posts/2020-08-29-compiling-a-lisp-0.md %})* -- *[previous]({% link _posts/2020-10-11-compiling-a-lisp-9.md %})*
</span>

Welcome back to the Compiling a Lisp series. In this thrilling new update, we
will learn a little bit more about x86-64 instruction encoding instead of
allocating more interesting things on the heap or adding procedure calls.

I am writing this interlude because I changed one register in my compiler code
(`kRbp` to `kRsp`) and all hell broke loose --- the resulting program was
crashing, `rasm2`/Cutter were decoding wacky instructions when fed my binary,
etc. Over the span of two very interesting but very frustrating hours, I
learned why I had these problems and how to resolve them. You should learn,
too.

### State of the instruction encoder

Recall that I introduced at least 10 functions that looked vaguely like this:

```c
void Emit_mov_reg_imm32(Buffer *buf, Register dst, int32_t src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0xc7);
  Buffer_write8(buf, 0xc0 + dst);
  Buffer_write32(buf, src);
}
```

These functions all purport to encode x86-64 instructions. They do, most of the
time, but they do not tell the whole story. This function is supposed to encode
an instruction of the form `mov reg64, imm32`. How does it do it? I don't know!

They have all these magic numbers in them! What is a `kRexPrefix`? Well, it's
`0x48`. Does that mean anything to us? No! It gets worse. What are `0xc7` and
`0xc0` doing there? Why are we adding `dst` to `0xc0`? Before this debugging
and reading extravaganza, I could not have told you. Remember how somewhere in
a previous post I mentioned I was getting these hex bytes from reading the
compiled output on the Compiler Explorer? Yeah.

As it turns out, this is not a robust development strategy, at least with
x86-64. It might be okay for some more regular or predictable instruction sets,
but not this one.

### Big scary documentation

So where do we go from here? How do we find out how to take these mystical
hexes and incantations to something that better maps to the hardware? Well, we
once again drag [Tom](https://tchebb.me/)[^1] into a debugging session and pull
out the big ol' Intel [Software Developer Manual][manual].

[manual]: https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html

This is an enormous 26MB, 5000 page manual comprised of four volumes. It's
*very intimidating*. This is exactly why I didn't want to pull it out earlier
and do this properly from the beginning... but here we are, eventually needing
to do it properly.

I will not pretend to understand all of this manual, nor will this post be a
guide to the manual. I will just explain what sections and diagrams I found
useful in understanding how this stuff works.

I only ever opened Volume 2, the instruction set reference. In that honking
2300 page volume are descriptions of every Intel x86-64 instruction and how
they are encoded. The instructions are listed alphabetically and split into
sections based on the first letter of each instruction name.

Let's take a look at Chapter 3, specifically at the MOV instruction on page
&nbsp; 1209. For those following along who do not want to download a massive
PDF, this [website](https://www.felixcloutier.com/x86/index.html) has a bunch
of the same data in HTML form. Here's the [page for
MOV](https://www.felixcloutier.com/x86/mov).

This page has every variant of MOV instruction. There are other instructions
begin with MOV, like MOVAPD, MOVAPS, etc, but they are different enough that
they are different instructions.

It has six columns:

* *Opcode*, which describes the layout of the bytes in the instruction stream.
  This describes how we'll encode instructions.
* *Instruction*, which gives a text-assembly-esque representation of the
  instruction. This is useful for figuring out which one we actually want to
  encode.
* *Op/En*, which stands for "Operand Encoding" and as far as I can tell
  describes the operand order with a symbol that is explained further in the
  "Instruction Operand Encoding" table on the following page.
* *64-Bit Mode*, which tells you if the instruction can be used in 64-bit mode
  ("Valid") or not (something else, I guess).
* *Compat/Leg Mode*, which tells you if the instruction can be used in some
  other mode, which I imagine is 32-bit mode or 16-bit mode. I don't know. But
  it's not relevant for us.
* *Description*, which provides a "plain English" description of the opcode,
  for some definition of the words "plain" and "English".

Other instructions have slightly different table layouts, so you'll have to
work out what the other columns mean.

Here's a preview of some rows from the table, with HTML courtesy of Felix
Cloutier's aforementioned web docs:

<table>
<tr>
<th>Opcode</th>
<th>Instruction</th>
<th>Op/En</th>
<th>64-Bit Mode</th>
<th>Compat/Leg Mode</th>
<th>Description</th></tr>
<tr>
<td>88 /<em>r</em></td>
<td>MOV <em>r/m8,r8</em></td>
<td>MR</td>
<td>Valid</td>
<td>Valid</td>
<td>Move <em>r8</em> to <em>r/m8.</em></td></tr>
<tr>
<td>REX + 88 /<em>r</em></td>
<td>MOV <em>r/m8</em><sup>***,</sup><em>r8</em><sup>***</sup></td>
<td>MR</td>
<td>Valid</td>
<td>N.E.</td>
<td>Move <em>r8</em> to <em>r/m8.</em></td></tr>
<tr>
<td>89 /<em>r</em></td>
<td>MOV <em>r/m16,r16</em></td>
<td>MR</td>
<td>Valid</td>
<td>Valid</td>
<td>Move <em>r16</em> to <em>r/m16.</em></td></tr>
<tr>
<td>89 /<em>r</em></td>
<td>MOV <em>r/m32,r32</em></td>
<td>MR</td>
<td>Valid</td>
<td>Valid</td>
<td>Move <em>r32</em> to <em>r/m32.</em></td></tr>
<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
<tr>
<td>C7 /<em>0 id</em></td>
<td>MOV <em>r/m32, imm32</em></td>
<td>MI</td>
<td>Valid</td>
<td>Valid</td>
<td>Move <em>imm32</em> to <em>r/m32.</em></td></tr>
<tr>
<td>REX.W + C7 /<em>0 id</em></td>
<td>MOV <em>r/m64, imm32</em></td>
<td>MI</td>
<td>Valid</td>
<td>N.E.</td>
<td>Move <em>imm32 sign extended to 64-bits</em> to <em>r/m64.</em></td></tr>
</table>

If you take a look at the last entry in the table, you'll see `REX.W + C7 /0
id`. Does that look familiar? Maybe, if you squint a little?

It turns out, that's the description for encoding the instruction we originally
wanted, and had a bad encoder for. Let's try and figure out how to use this to
make our encoder better. In order to do that, we'll need to first understand a
general layout for Intel instructions.

### Instruction encoding, big picture

All Intel x86-64 instructions follow this general format:

* *optional* instruction prefix
* opcode (1, 2, or 3 bytes)
* *if required,* Mod-Reg/Opcode-R/M, also known as ModR/M (1 byte)
* *if required,* Scale-Index-Base, also known as SIB (1 byte)
* displacement (1, 2, or 4 bytes, or none)
* immediate data (1, 2, or 4 bytes, or none)

I found this information at the very beginning of Volume 2, Chapter 2 (page
527) in a section called "Instruction format for protected mode, real-address
mode, and virtual-8086 mode".

You, like me, may be wondering about the difference between "optional", "if
required", and "..., or none". I have no explanation, sorry.

I'm going to briefly explain each component here, followed up with a
piece-by-piece dissection of the particular MOV instruction we want, so we get
some hands-on practice.

#### Instruction prefixes

There are a couple kind of instruction prefixes, like REX (Section 2.2.1) and
VEX (Section 2.3). We're going to focus on REX prefixes, since they are needed
for many (most?) x86-64 instructions, and we're not emitting vector
instructions.

The REX prefixes are used to indicate that an instruction, which might normally
refer to a 32-bit register, should instead refer to a 64-bit register. Also
some other things but we're mostly concerned with register sizes.

#### Opcode

Take a look at Section 2.1.2 (page 529) for a brief explanation of opcodes. The
gist is that the opcode is the *meat* of the instruction. It's what makes a MOV
a MOV and not a HALT. The other fields all modify the meaning given by this
field.

#### ModR/M and SIB

Take a look at Section 2.1.3 (page 529) for a brief explanation of ModR/M and
SIB bytes. The gist is that they encode what register sources and destinations
to use.

#### Displacement and immediates

Take a look at Section 2.1.4 (page 529) for a brief explanation of displacement
and immediate bytes. The gist is that they encode literal numbers used in the
instructions that don't encode registers or anything.

If you're confused, that's okay. It should maybe get clearer once we get our
hands dirty. Reading all of this information in a vacuum is moderately useless
if it's your first time dealing with assembly like this, but I included this
section first to help explain how to use the reference.

### Encoding, piece by piece

Got all that? Maybe? No? Yeah, me neither. But let's forge ahead anyway. Here's
the instruction we're going to encode: `REX.W + C7 /0 id`.

#### REX.W

First, let's figure out `REX.W`. According to Section 2.2.1, which explains REX
prefixes in some detail, there are a couple of different prefixes. There's a
helpful table (Table 2-4, page 535) documenting them. Here's a bit diagram with
the same information:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 626.0000000000003 128.05555555555554">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="626.0000000000003" height="128.05555555555554" fill="#ffffff"></rect><g transform="translate(274.27777777777794 59.16666666666663) rotate(0 30 28.888888888888886)"><path d="M0.282781258225441 -1.8658841997385025 C21.524194687604904 0.3263779416680336, 43.51525716483593 0.5620313420891762, 59.49974836409092 0.35328303277492523 M-0.23636383563280106 0.48129016906023026 C22.33357594162226 1.3931672364473342, 43.38550271838904 -0.1093220919370651, 60.771481804549694 0.198187418282032 M59.07265104353428 -0.06147755682468414 C60.808595448732376 23.39022936589188, 61.79160812497139 43.80102747513188, 58.67354454100132 56.44631645248995 M60.97932367771864 0.9332471564412117 C61.0181736709343 19.376891723109615, 60.627089238332374 39.6501947980788, 59.43717389553785 57.598889285491566 M60.95579780638218 59.09368965195284 C37.140545189380646 56.58890948610173, 13.368886932730675 58.918221333788495, -1.9358471482992172 56.500082226263146 M59.70537953823805 58.153468066619496 C41.87183416634798 56.3581919895278, 22.80299063771963 58.02151992188559, -0.5461894944310188 58.66469209806786 M-1.2606495469808578 56.96349546478854 C1.3280181778801812 39.56183260182539, 0.8311419381035698 20.12219061288568, 1.4943272024393082 0.6683889478445053 M0.8468330428004265 57.25558679716454 C-1.2163042907913526 40.90151360051499, -0.6621219997604688 25.07094656841622, 0.5936084315180779 0.07259780913591385" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(355.388888888889 59.16666666666663) rotate(0 30 28.888888888888886)"><path d="M0.9892207235097885 -1.3264554589986801 C17.91910222172737 0.6104068741202354, 39.34811396896839 0.4834799751639366, 61.95864735543728 1.8664943128824234 M-0.9697036072611809 -0.5628261044621468 C22.46204295009375 0.6441463679075241, 44.28936598449946 -1.0473149567842484, 60.47789890319109 0.6579559370875359 M61.63116703927517 -1.9358471482992172 C58.5206181704998 18.79514794051647, 58.401413172483444 35.087803795933716, 59.4107590764761 58.52915835546122 M60.77967006713152 -0.5461894944310188 C60.3763564426038 23.039876867499615, 60.26906975093815 45.00270561956697, 59.36967522650957 57.370636621283154 M59.79775629937649 59.27210498021708 C37.3329798579216 57.9651572169529, 15.18276335299015 56.39642733948098, 1.693666085600853 56.73339581655131 M60.82104355841875 58.37138620929585 C46.157548896968365 58.07063684331045, 32.67722836881876 56.84446177350149, -0.18946855515241623 57.94115201549397 M-0.07595290243625641 59.45522427724467 C-0.11518774032592771 39.320549128784066, -1.4454217910766602 20.885230059425034, -1.0231980234384537 1.208210602402687 M0.44079381972551346 57.336249748037915 C-0.7576514596740405 36.01054775963227, -0.35927714059750243 14.172448005113338, -0.15534298866987228 -0.5614060834050179" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(438.72222222222206 60.277777777777715) rotate(0 30 28.888888888888886)"><path d="M-1.3264554589986801 -1.331461325287819 C24.98334500193596 0.5502206578850746, 48.80939607322216 1.6618811383843421, 61.86649431288242 1.5469771474599838 M-0.5628261044621468 -0.1788884922862053 C13.275243975222113 -0.41067473590373993, 23.98543777316809 1.0597210675477982, 60.657955937087536 0.19103915244340897 M58.06415285170078 -1.2776955515146255 C60.315263751480316 13.919570003946623, 58.170804503891205 30.04370018343131, 60.75138057768345 59.669643135534386 M59.45381050556898 0.8869143202900887 C60.790729816920226 13.007382185094885, 59.95483642435736 23.825184339450463, 59.59285884350538 58.667012626098256 M61.49432720243931 58.44616672562228 C40.2707217335701 59.57068620042668, 19.169812187552452 59.41077075319157, -1.0443819612264633 56.416127415166955 M60.59360843151808 57.850375586913685 C43.042805559933186 58.77773010598288, 24.490591250360012 58.08093535767661, 0.16337423771619797 58.01560657636986 M1.677446499466896 57.797753544317345 C0.039253393809000725 37.78255109157827, 0.3113896052042644 19.384642950362625, 1.208210602402687 1.533988580107689 M-0.4415280297398567 56.77825420515404 C-0.3269432589411735 42.26201632039414, -0.4001871153712272 27.793210381435017, -0.5614060834050179 0.3669479563832283" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(516.5000000000003 60.277777777777715) rotate(0 30 28.888888888888886)"><path d="M-0.22465358674526215 -0.2532857805490494 C24.72308537364006 1.5957119718194008, 46.307192131876945 1.1461847081780434, 61.014652386307716 -1.7146605402231216 M0.2339368388056755 0.3651459887623787 C16.825212217867374 0.6960259705781937, 33.73636522144079 -0.017583963274955705, 59.34487085789442 0.26118142157793045 M59.162750378251076 1.123508557677269 C61.230626257922914 13.494371872809198, 58.34999147322443 28.750107624464565, 58.79770149290562 57.626541824804406 M60.944802574813366 0.5650888159871101 C59.07786855449279 15.794553389979733, 60.25044378985961 33.609535847273136, 59.28113179653883 57.290728503631215 M58.186400070786476 57.495594711767296 C42.87429457902908 58.84347834901676, 27.24250219762325 56.97979703264103, 1.2155314832925797 56.6980077938901 M60.425802282989025 57.679779941009144 C46.277098067104816 57.59357712136374, 32.85598631948233 58.612190698252775, 0.8906028792262077 58.06936090605126 M-1.471575602889061 59.35185071991549 C-2.1352061059739853 48.008055119050866, 1.3870826933119034 32.80206164220968, 0.965896263718605 0.7785459607839584 M0.14446526020765305 57.26035326139794 C-0.18164619786871805 36.869497058292225, 0.18228951113091574 15.633006394737286, 0.5080009028315544 -0.2884194180369377" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(106.50000000000023 56.94444444444446) rotate(0 74.99999999999994 30.555555555555543)"><path d="M-0.004748240113258362 -1.2022985070943832 C51.46067134290932 1.1885993815958493, 102.10100242495534 2.2331812717020503, 151.88960514962668 1.1301776319742203 M0.7379437163472176 -0.7188682034611702 C35.54649843275546 -1.2177299521863458, 71.13148900121449 -1.5193597339093683, 149.09320003539318 -0.14109153300523758 M149.59630452096457 1.2155314832925797 C149.36633679974403 12.91017072813378, 152.28070113766518 30.678189489576543, 150.851604565978 60.91511543757383 M150.3231938555836 0.8906028792262077 C149.8666044096979 14.570648643705574, 149.9388221125635 30.15284742332166, 149.2642121985554 61.898147582179945 M148.24153147637838 62.07700737482969 C120.21612148731943 63.50114316037957, 87.43105268478391 62.236734571970146, 0.2889305204153061 60.07626207835142 M149.4094281867146 61.61911201394264 C113.6940331459045 60.465041357196014, 77.41767161339519 61.249791580355804, 0.1307886317372322 60.40915369904701 M1.4909912198781967 60.74828585154478 C-2.010100583649344 45.67236099226605, -1.8145777984625764 26.55751096208889, -0.5039833933115005 0.21762146055698395 M-0.2794763371348381 60.508841275340956 C0.02256062254309643 39.35567450357806, 0.16684558615088452 19.340500590701886, 0.17461878806352615 -0.9764813855290413" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(147.05555555555566 72.38888888888891) rotate(0 35 18)"><text x="35" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0100</text></g><g transform="translate(292.77777777777794 70.05555555555554) rotate(0 11.5 18)"><text x="11.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">W</text></g><g transform="translate(376.388888888889 70.05555555555554) rotate(0 9 18)"><text x="9" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">R</text></g><g transform="translate(460.22222222222206 71.16666666666663) rotate(0 8.5 18)"><text x="8.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">X</text></g><g transform="translate(536.5000000000003 71.16666666666663) rotate(0 10 18)"><text x="10" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">B</text></g><g transform="translate(53.666666666666856 10) rotate(0 49.5 18)"><text x="49.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">High bit</text></g><g transform="translate(517.0000000000003 12.277777777777715) rotate(0 49.5 18)"><text x="49.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Low bit</text></g><g transform="translate(10 67.77777777777777) rotate(0 26.5 18)"><text x="26.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">REX</text></g></svg>

In English, and zero-indexed:

* Bits 7-4 are always `0b0100`.
* Bit 3 is the W prefix. If it's 1, it means the operands are 64 bits. If it's
  0, "operand size [is] determined by CS.D". Not sure what that means.
* Bits 2, 1, and 0 are other types of REX prefixes that we may not end up
  using, so I am omitting them here. Please read further in the manual if you
  are curious!

This MOV instruction calls for REX.W, which means this byte will look like
`0b01001000`, also known as our friend `0x48`. Mystery number one, solved!

#### C7

This is a hexadecimal literal `0xc7`. It is the *opcode*. There are a couple of
other entries with the opcode `C7`, modified by other bytes in the instruction
(ModR/M, SIB, REX, ...). Write it to the instruction stream. Mystery number
two, solved!

#### /0

There's a snippet in Section 2.1.5 that explains this notation:

> If the instruction does not require a second operand, then the Reg/Opcode
> field may be used as an opcode extension. This use is represented by the
> sixth row in the tables (labeled "/digit (Opcode)"). Note that values in row
> six are represented in decimal form.

This is a little confusing because this operation clearly *does* have a second
operand, denoted by the "MI" in the table, which shows Operand 1 being
`ModRM:r/m (w)` and Operand 2 being `imm8/16/32/64`. I think it's because it
doesn't have a second *register* operand that this space is free --- the
immediate is in a different place in the instruction.

In any case, this means that we have to make sure to put decimal `0` in the
`reg` part of the ModR/M byte. We'll see what the ModR/M byte looks like in
greater detail shortly.

#### id

*id* refers to an immediate *double word* (32 bits). It's called a *double*
word because, a word (*iw*) is 16 bits. In increasing order of size, we have:

* *ib*, byte (1 byte)
* *iw*, word (2 bytes)
* *id*, double word (4 bytes)
* *io*, quad word (8 bytes)

This means we have to write our 32-bit value out to the instruction stream.
These notations and encodings are explained further in Section 3.1.1.1 (page
596).

Overall, that means that this instruction will have the following form:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 573.4999999999999 126.5">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="573.4999999999999" height="126.5" fill="#ffffff"></rect><g transform="translate(24 58) rotate(0 39.5 27.5)"><path d="M-0.9273641556501389 -0.7951573878526688 C25.596636665612458 -1.031335658207536, 47.40794522613287 0.02705829702317708, 78.86474676430224 -0.8089403659105301 M0.2504737600684166 0.6188722625374794 C21.859393621236084 0.015204895809292962, 44.046217229962345 -0.3455083476752041, 78.50442364066838 0.03355870395898819 M78.00074453651904 0.939522311091423 C78.54314449690281 16.675135422497988, 79.20698717497288 33.04214196652174, 78.00154991447924 54.81592182815075 M79.6735158190131 -0.7179004177451134 C79.07919127829372 12.919680628925562, 78.75133259184658 24.850085467100143, 79.47045733779667 54.4461527839303 M77.12180061638354 56.4375534504652 C61.43844591900705 54.241339490786196, 42.01212552338838 55.90865068234503, 1.1989762336015701 54.781772181391716 M78.22261836379765 54.01103887706995 C47.554011603444806 55.196776532456276, 16.62688280940055 54.96983709268272, -0.35956761986017227 54.31142172962427 M0.721448615193367 56.04610399901867 C-0.006372788175940558 38.790566485375166, 0.3674003098160028 26.681070841848847, 1.820795252919197 -0.3923463374376297 M0.2979278787970543 54.27663741260767 C0.03611607365310188 34.71534148976207, -0.4950964946299792 17.166107639670372, -0.24956724792718887 -0.8606246933341026" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(44 74.5) rotate(0 19 13)"><text x="19" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">REX</text></g><g transform="translate(138 73) rotate(0 12 13)"><text x="12" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Op</text></g><g transform="translate(201 76) rotate(0 36 13)"><text x="36" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">ModR/M</text></g><g transform="translate(110.5 59.5) rotate(0 39.5 27.5)"><path d="M-0.3604028671979904 -1.0068025141954422 C23.110345066338777 0.8204789646714925, 46.18676011413336 -0.5144986621290446, 79.53272123634814 -1.0132002383470535 M-0.08780119568109512 -0.2515167221426964 C21.990919709950685 -0.5261391078680754, 46.37898967564106 -0.18577202908694745, 79.32902099937199 0.1726606860756874 M77.36256666481493 -0.5445227175951004 C78.06932519339024 20.61890821531415, 77.28962539099156 39.00162320584059, 80.84524460136889 54.802152678370476 M78.24103309959172 -0.09124960750341415 C78.54894773848353 20.26872876659036, 79.97752826102077 42.48696061968804, 78.90104224532841 54.210224248468876 M80.92496795952319 55.12837414443493 C50.24421307370065 53.359036739245056, 18.01385186463593 54.629070098772644, -0.19762448966503143 55.46825937926769 M78.63831069320439 55.895471669733524 C57.186408015340554 54.81674747399986, 37.26992861628531 54.69909148149193, -0.849362351000309 55.42995486408472 M1.0499455481767654 56.921556040644646 C-1.069080736860633 37.16401247307658, -1.9474438693374396 19.265401400625706, -1.7946165055036545 0.06666283309459686 M0.7854280695319176 54.39834437519312 C-0.38140306659042833 32.844784181565046, 0.8418704491108656 11.80621574819088, -0.9048588052392006 -0.4393877014517784" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(197.5 59.5) rotate(0 39.5 27.5)"><path d="M0.6358372718095779 0.5009475201368332 C21.74243007972836 -0.43634311355650435, 41.54209234565496 -0.615513245239854, 78.81129474937914 -0.9911527186632156 M-0.9636945500969887 -0.4996277317404747 C24.434874916821716 0.039437557533383294, 48.259248521924015 0.3713588965684175, 79.50397755950688 -0.49922504276037216 M78.34389896690844 1.3470316380262375 C77.11390499733388 16.451655078679323, 80.394950434193 31.7897227331996, 80.71193762123583 55.940914675593376 M78.29019620269536 -0.9390996918082237 C79.30134493000804 13.525144014507534, 78.48361045010387 26.117904871702198, 79.73469784110783 55.599488116800785 M79.74832601845263 53.44523672759533 C54.18407763764261 54.765977874174716, 33.1263752773404 55.51896716631949, -0.6515033692121506 54.280864760279655 M78.31296970695256 55.36072430759668 C61.26282033547758 55.950490934178234, 41.63017432093619 56.137377483174205, 0.3512442335486412 55.9103976264596 M-0.5683620423078537 55.59585575759411 C-1.7354602005332709 40.70804039761424, -2.083351531252265 24.224567689001557, 1.8816163092851639 -0.49913449585437775 M-0.5186650529503822 54.51922903209925 C0.27262302450835696 43.388541262596846, -1.3368442434817553 31.02748392522335, 0.31626322120428085 0.34195075184106827" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(373.5 74) rotate(0 48.5 13)"><text x="48.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Immediate</text></g><g transform="translate(10 16) rotate(0 13.5 17)"><path d="M-0.18870525062084198 -0.9911527186632156 C7.0411767639219764 -0.03882035918533802, 13.445085267722607 -1.790607068017125, 26.00074453651905 0.939522311091423 M0.5039775595068932 -0.49922504276037216 C7.577957151085139 -0.8653350528329611, 15.067731115221978 -0.37466890178620815, 27.67351581901312 -0.7179004177451134 M28.711937621235847 0.9409146755933762 C26.205997150093317 9.460445286333561, 27.131192367225886 20.537150579690934, 25.121800616383553 35.4375534504652 M27.734697841107845 0.5994881168007851 C26.857240454107522 11.404916569590569, 27.03054143562913 21.25902818888426, 26.222618363797665 33.01103887706995 M26.34849663078785 33.280864760279655 C17.9072288416326 33.33983640260995, 13.35971410423517 32.689154430106285, 0.721448615193367 35.04610399901867 M27.35124423354864 34.9103976264596 C18.047542380541564 34.64106058739126, 10.448209118843078 33.83190679214895, 0.2979278787970543 33.27663741260767 M1.8816163092851639 33.50086550414562 C-1.416164580732584 23.451406590640545, -0.8982264436781406 8.723770797252655, -0.961541935801506 1.4092169255018234 M0.31626322120428085 34.34195075184107 C0.6123941139876843 23.479525953531265, 0.8284349636733532 13.260022602975368, -0.8019716516137123 0.026404954493045807" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(16 20) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0</text></g><g transform="translate(113 18) rotate(0 2 13)"><text x="2" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">1</text></g><g transform="translate(101.5 12) rotate(0 13.5 17)"><path d="M-0.9992554634809494 0.939522311091423 C7.54441546574235 0.9182395272701979, 16.071194915473463 1.2681526475399734, 26.001549914479256 -0.1840781718492508 M0.6735158190131187 -0.7179004177451134 C6.118400023132563 1.0111959401518107, 11.6800063341856 0.9445424500852824, 27.470457337796688 -0.5538472160696983 M25.121800616383553 1.4375534504652023 C27.111582539230586 7.421597029268742, 25.38942363038659 16.70842075943947, 28.19897623360157 33.781772181391716 M26.222618363797665 -0.9889611229300499 C26.879458648115396 13.373633286356927, 27.255953294187783 26.61913937777281, 26.640432380139828 33.31142172962427 M27.721448615193367 35.04610399901867 C20.36269775852561 32.11577711887658, 13.613031984865664 34.51699028797448, 1.820795252919197 33.60765366256237 M27.297927878797054 33.27663741260767 C18.047117494791745 33.02596287153661, 7.99847843647003 34.86407927893102, -0.24956724792718887 33.1393753066659 M-0.961541935801506 35.40921692550182 C0.5147738109529019 19.31982695311308, -0.6742124904692173 8.891615569591522, 0.6839015036821365 0.6094842404127121 M-0.8019716516137123 34.026404954493046 C0.4164921240508556 22.750924307107923, 0.06082429453730581 11.40571862310171, 0.18497993797063828 -0.8334142193198204" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(182.5 12) rotate(0 13.5 17)"><path d="M-0.31852130591869354 0.6580419987440109 C5.843346086889506 0.8811196070164442, 9.997599343955518 -0.3109136838465929, 25.36256666481495 -0.5445227175951004 M0.22893502563238144 0.9226223006844521 C7.115339944511653 1.0498019234091043, 14.89898454844952 -0.3600141032785177, 26.241033099591732 -0.09124960750341415 M27.142607405781746 -0.19791550934314728 C25.101154601722957 9.256062771379948, 27.879682338386775 15.355106359720232, 28.9249679595232 34.12837414443493 M26.85763504356146 -0.09881224483251572 C26.969819933325052 11.146402546763419, 26.376122623831034 22.25573019236326, 26.638310693204403 34.895471669733524 M27.486136630177498 32.30127529799938 C21.614891519397496 34.843712506964806, 16.330758835375306 33.748877702429894, 1.0499455481767654 35.921556040644646 M27.56454398483038 33.10269174724817 C19.700620173662898 34.745500256046654, 12.085010266304014 32.94406740806997, 0.7854280695319176 33.39834437519312 M0.3102108985185623 32.1902823895216 C-0.7153132738173008 26.19598762243986, 0.8473636327683925 17.73640660047531, 0.4137689620256424 1.04156593978405 M0.5935583338141441 33.65433154255152 C0.5105608658492565 20.58241825699806, 0.4576502995193005 7.90635610669851, 0.26221921294927597 -0.41637172549963" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(188.5 16) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">2</text></g><g transform="translate(273 15) rotate(0 7 13)"><text x="7" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">3</text></g><g transform="translate(544.9999999999999 17) rotate(0 4 13)"><text x="4" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">7</text></g><g transform="translate(267.5 10) rotate(0 13.5 17)"><path d="M-0.6561010330915451 1.3470316380262375 C6.415693632513285 0.5313806181401014, 17.54823353737593 -0.12433675475418568, 28.711937621235847 0.9409146755933762 M-0.7098037973046303 -0.9390996918082237 C7.323389241844416 0.09594109691679478, 13.110267278552056 -0.7651383575052023, 27.734697841107845 0.5994881168007851 M27.748326018452644 -1.5547632724046707 C25.349322307258845 9.544282795488835, 27.129620063453913 20.126284795999528, 26.34849663078785 33.280864760279655 M26.312969706952572 0.3607243075966835 C27.40007763519883 8.101902195811272, 26.027663284689186 16.147622625529767, 27.35124423354864 34.9103976264596 M26.431637957692146 34.59585575759411 C17.98294238075614 35.388498035147784, 10.064718605577944 34.32607289858162, 1.8816163092851639 33.50086550414562 M26.481334947049618 33.51922903209925 C21.92829513475299 33.99265843056142, 14.542514538764953 33.39816527985036, 0.31626322120428085 34.34195075184107 M1.4294793158769608 32.396056696772575 C-0.017530814558267604 23.950993458926675, -0.7616776384413242 12.003534591197965, -1.5749338120222092 0.36995987594127655 M-0.6795615926384926 34.88236174732447 C0.3947505669295788 27.21665821671486, 0.3111698345839977 19.324735508859156, 0.49083878844976425 -0.7208427414298058" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(536.4999999999999 13) rotate(0 13.5 17)"><path d="M-1.4358008354902267 0.4578700512647629 C9.21013893261552 -0.3796965927630663, 16.44172628372908 0.7590654044598342, 25.892305567860603 -1.517933800816536 M0.7187767252326012 0.07130370289087296 C7.75466830506921 -0.5362188347429038, 16.44194996058941 0.8530450335890054, 26.890886090695858 0.9624839797616005 M25.0220777541399 -0.2847299128770828 C26.929590933471918 10.886495424807073, 26.4757120539248 20.117336851358417, 25.622843459248543 33.276621386408806 M27.523051999509335 0.24306831508874893 C25.917047349363564 13.674558541178705, 27.117653933912514 27.399604980647567, 26.803826831281185 34.52497277408838 M25.55327482521534 35.12908796966076 C14.511282839626073 34.147103360369805, 7.493414999544619 33.58130603142083, -1.7212493866682053 35.570856139063835 M27.70460846275091 34.15510544925928 C19.61961138173938 33.43080413721502, 14.365203595161438 34.21214259050787, 0.30474212020635605 34.20688448101282 M0.052809908986091614 35.18711666762829 C-0.9343483985960483 22.505118910968303, -1.8179452957212925 10.428635680675505, -1.6668284386396408 0.5244384258985519 M0.4839050993323326 34.58304987102747 C0.631375308483839 25.27318268418312, 0.7218897299468517 15.710484991967675, 0.2000284418463707 -0.4270836338400841" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(287.5 57.5) rotate(0 133.5 29.5)"><path d="M1.5512318976058124 0.6265101301775813 C85.15533915996396 0.3400806055988444, 170.30386704098666 0.322602097936262, 268.3253825445987 -0.7573336767945409 M-0.757294413912636 -0.38524917685436605 C94.47535937491388 0.07154714317670367, 189.20899366954484 -0.4735799543256232, 267.5978203106836 -0.6436101929941594 M265.83684988319874 1.5807118862867355 C265.53728800587356 22.505770406872028, 267.39888459019363 46.64034736007451, 267.93091697990894 59.29353718459604 M267.8864445909858 -0.4331485256552696 C266.0061227080971 21.61957967355847, 265.76298081852497 42.551069164276115, 266.68753650039434 58.074410535395124 M266.3659707548301 58.671388003092446 C164.93282549949325 59.526996783066416, 61.867042760477254 60.950265433533716, -0.758334178426063 58.87537559550997 M266.87086245497886 59.26531148596185 C177.76157160116864 60.07835468402525, 87.88805734808469 60.14368492445016, 0.03721462809805274 59.6435577211038 M-1.1699851006269455 58.64920763671396 C-0.586123616024852 40.28687566146253, 1.2666533882170914 26.64871055632829, -1.1336267441511154 -1.2965669184923172 M0.5386886820197105 58.04136977344749 C-0.5326534108072517 36.40269506201146, -0.36977418221533276 14.862019923329342, 0.8234689459204674 -0.3305114731192589" stroke="#000000" stroke-width="1" fill="none"></path></g></svg>

If we were to try and encode the particular instruction `mov rax, 100`, it
would look like this:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 566.4999999999999 166">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="566.4999999999999" height="166" fill="#ffffff"></rect><g transform="translate(24 59) rotate(0 39.5 27.5)"><path d="M1.614336058497429 1.6158797293901443 C16.779538797587154 -0.1003872510045768, 32.52291231304407 -1.4568082448095083, 78.42687754333018 -1.1941059082746506 M0.4249516502022743 0.8411069139838219 C20.060966526716946 -0.18762885339558144, 42.301572772860524 0.227066171094775, 79.06685671955346 -0.7592904344201088 M77.97392420470713 -1.7047145813703537 C78.78041351772843 16.133124124258757, 79.01286447979508 34.87643463164568, 79.21668724715708 54.710107520222664 M79.23837123066185 0.41767527908086777 C79.11091535799204 12.2033570073545, 79.17843240015208 25.968797951936725, 79.69556102901696 54.42643167823553 M77.28534035384654 54.66422052681446 C60.5490830130875 53.34849779449403, 42.87439488619565 53.71763222061097, -1.5577883273363113 54.99965114891529 M79.4217020049691 54.97748186439276 C57.64266940727829 55.687459034398195, 38.453091460466375 55.265987677052614, -0.6219855770468712 55.134210370481014 M-1.4479975253343582 54.71145458519459 C0.10250175856053834 35.63457955792546, -0.014137855544686273 18.24540289491415, -1.721256211400032 1.2414195090532303 M0.8677662387490273 54.94411065429449 C-0.35609889440238485 36.66411020234227, -0.5429916422814132 19.121193185448647, -0.4538983330130577 -0.1264328733086586" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(47 128.5) rotate(0 19 13)"><text x="19" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">REX</text></g><g transform="translate(138 127) rotate(0 12 13)"><text x="12" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Op</text></g><g transform="translate(204 130) rotate(0 36 13)"><text x="36" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">ModR/M</text></g><g transform="translate(110.5 60.5) rotate(0 39.5 27.5)"><path d="M-0.7753304988145828 -1.9785082787275314 C29.50960247442126 -0.9483814307302237, 59.47915153652429 -0.06075335226953038, 77.00867705047129 0.8499033004045486 M0.32332954555749893 -0.559506393969059 C30.411601340025662 0.010328686162829226, 60.98092934787273 0.8750206588953732, 78.83765587955712 -0.5130378976464272 M78.95489363372324 -1.3294065445661545 C79.14035898186265 11.522142421454191, 77.52378040291367 25.46959287673235, 80.24431805312632 55.47674246132374 M78.67091355472802 0.6682002767920494 C79.47742911092935 18.223645713180304, 78.0654081892222 37.35894802212715, 78.14261446148156 54.142670176923275 M78.95432858169077 54.394966796040535 C55.068540591746554 54.61485493503511, 33.41326712816953 56.38624155841768, 1.764306589961052 55.84340400993824 M79.2219048514962 54.569086574018 C54.855907694250334 55.12675113625824, 32.42458003163337 54.12305016465485, 0.8191932216286659 54.27600123733282 M-0.49235768616199493 56.40213127434254 C-1.6179337415844202 40.534919399768114, 0.6644439782947302 25.4833355769515, -1.9748143702745438 1.7355324774980545 M-0.02149929851293564 55.2073614820838 C-0.5448647301644087 38.68095852807164, 0.8678061205893755 23.522986665368073, -0.0913480743765831 0.5371017679572105" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(197.5 60.5) rotate(0 39.5 27.5)"><path d="M-1.9785082787275314 -0.5731224566698074 C23.021042788773773 -0.3800427786260844, 48.12381956428289 -1.685067402496934, 79.84990330040453 1.6822138279676437 M-0.559506393969059 0.06685671955347061 C15.608284378796814 0.036009765937924376, 32.84055116474628 -0.41777446143329144, 78.48696210235356 -0.8523572906851768 M77.67059345543383 0.21668724715709686 C78.16841349266468 14.336826015263798, 80.30382904671131 32.71775274723768, 79.47674246132372 55.835350558161736 M79.66820027679204 0.6955610290169716 C78.1806136716157 13.602220926433802, 78.51870194561778 27.779976099729538, 78.14267017692326 54.83211026340723 M78.39496679604052 53.44221167266369 C56.922904198616735 54.14256907977164, 36.617543871700754 56.746266379728915, 0.84340400993824 54.954963728785515 M78.56908657401799 54.37801442295313 C63.120309158414585 55.64409832172096, 46.102706974744784 55.99449805431068, -0.7239987626671791 54.855727292597294 M1.402131274342537 53.27874378859997 C1.3203599784523248 40.09434620663524, 1.9752762649208306 22.091635026037693, 1.7355324774980545 -0.11177869141101837 M0.20736148208379745 54.54610166698694 C0.03461023382842543 38.54910854622722, 1.069246969744563 20.089323982596397, 0.5371017679572105 0.4394410625100136" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(283.5 58.5) rotate(0 133.5 29.5)"><path d="M-0.4517915155968785 -0.9413117769234538 C71.25412687424453 1.8405433226499206, 142.02051279756984 2.7521167173913605, 268.32608646904475 -1.4633263399647594 M0.052703045053249596 -0.5985474345886767 C54.31856389712106 1.2607127110746268, 108.0496686438727 0.7731978932113531, 266.32808811152455 -0.10939899892068505 M267.2166872471571 -0.2898924797773361 C265.58680229015647 13.734623505920169, 268.2310116750747 24.254943324625486, 267.83535055816174 58.20679302513597 M267.695561029017 -0.5735683217644691 C266.08937910459935 14.827563153952356, 265.9484534587711 29.268756580352775, 266.83211026340723 58.794524930417516 M265.7719979540221 58.999725001248066 C199.24344750785517 59.7593823888934, 134.20107578501586 59.02813017823934, -0.035502020540344716 57.466091297020235 M266.5096897647909 59.10579782031357 C187.52165238993214 57.40761401779903, 107.9499751710854 57.52230500126632, -0.1137299444092214 58.85191102247326 M-1.721256211400032 60.24141950905321 C0.7063670258969068 44.04315173998474, -1.8295688528567553 27.029164366424077, -0.11177869141101837 0.33078689873218536 M-0.4538983330130577 58.87356712669132 C0.9714571038633585 43.935757193714366, -0.07866348825395109 27.592208430171002, 0.4394410625100136 0.25952842086553574" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(363.5 130) rotate(0 48.5 13)"><text x="48.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Immediate</text></g><g transform="translate(10 17) rotate(0 13.5 17)"><path d="M-0.6862983256578445 -0.3064778298139572 C3.4376908741891388 1.0111075980216264, 12.54024147540331 -1.6951058762520552, 25.05159716308117 0.6466590911149979 M0.29144010692834854 0.10540153831243515 C6.426988615840674 -0.30802948035299776, 12.326308181881906 0.06622975312173368, 26.01510176807642 -0.022553183138370514 M25.600108668208122 1.8455230742692947 C28.281154885143042 8.416751335561276, 27.872187390178443 15.08681077361107, 26.106116339564323 33.34182710945606 M26.28354010730982 -0.23548004776239395 C26.37910521134734 11.614551118016244, 27.068601013273 24.738286812603477, 26.512916184961796 33.977164290845394 M26.160609290003777 35.77103777229786 C21.481101415306327 34.8433569150418, 12.388553379476068 32.054105110689996, -0.018884137272834778 34.44380970299244 M27.468793489038944 33.13050939887762 C20.88265947178006 33.3122380373627, 12.982659792900083 33.84837776400149, -0.14352812618017197 33.753821156919 M0.5611215084791183 35.896335795521736 C-1.6822008143365383 23.15190931111574, 0.1808348645269871 9.163540565967558, -0.5856112986803055 -0.04299859702587128 M0.9587725177407265 34.90820386260748 C0.06297735884785655 23.6320727288723, 0.5937664957344533 12.449470342695712, -0.3035963997244835 -0.9018111005425453" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(16 21) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0</text></g><g transform="translate(113 19) rotate(0 2 13)"><text x="2" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">1</text></g><g transform="translate(101.5 13) rotate(0 13.5 17)"><path d="M0.8499033004045486 1.6822138279676437 C5.317187086492778 -1.679574238732457, 14.99365361183882 -0.8501841897517443, 27.13371343910694 -1.5185808688402176 M-0.5130378976464272 -0.8523572906851768 C8.748109624534845 -0.941065319404006, 17.75122339427471 -0.620870359763503, 27.10834362357855 -0.14494623988866806 M27.476742461323738 0.8353505581617355 C26.520531947761775 6.926301075518132, 26.655566032081843 16.976770025491717, 28.391122058033943 32.85286335647106 M26.142670176923275 -0.16788973659276962 C26.714461714178324 7.276952549815178, 26.89710107460618 15.225556127727032, 26.221105836331844 33.999825574457645 M27.84340400993824 33.954963728785515 C18.087329664081334 34.21929725237191, 13.510164619982241 33.37635453768075, -1.2439711540937424 34.26842074096203 M26.27600123733282 33.855727292597294 C17.446398543566467 34.07765404365957, 8.022336316108703 34.92224780701101, -0.860628105700016 34.620709754526615 M1.7355324774980545 33.88822130858898 C0.008409813493490181 22.260482136905193, -0.36537568226456646 12.106909835338591, -0.9077966660261154 -0.2528657466173172 M0.5371017679572105 34.439441062510014 C-0.04926089242100723 20.236577039957048, -1.2106004138290882 7.756712590157985, 0.8492257818579674 0.9777160659432411" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(182.5 13) rotate(0 13.5 17)"><path d="M1.6822138279676437 -1.856310173869133 C5.737852092832327 0.5319221455603838, 14.253497071564198 0.018976493552327167, 25.481419131159782 0.5828802138566971 M-0.8523572906851768 -0.1387786641716957 C7.399685921519996 0.11596704922616483, 16.104465034604075 0.24686385594308377, 26.855053760111332 -0.6999456658959389 M27.835350558161736 -0.793206974864006 C26.3176504085958 12.679216335713864, 28.547934622615575 28.065900510549547, 25.85286335647106 32.56708021461964 M26.83211026340723 -0.2054750695824623 C26.22140510186553 9.376532128453256, 26.405972314924 18.01984151154757, 26.999825574457645 33.58030464500189 M26.954963728785515 32.05415220558643 C16.490214870125055 34.5576692443341, 5.156371162831782 32.86988838724792, 0.2684207409620285 34.93758697807789 M26.855727292597294 33.812140963971615 C21.104096496850254 33.55834149099886, 16.196314883232116 32.943892228379845, 0.6207097545266151 34.28056075423956 M-0.11177869141101837 34.330786898732185 C-0.249892855733633 20.533230550587177, 0.7504414071142673 6.244661629199982, -0.2528657466173172 1.917545035481453 M0.4394410625100136 34.259528420865536 C-0.27253805443644524 19.810295766592027, 0.7074240560829639 8.273439516127109, 0.9777160659432411 -0.6677808538079262" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(188.5 17) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">2</text></g><g transform="translate(273 16) rotate(0 7 13)"><text x="7" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">3</text></g><g transform="translate(540.9999999999999 16) rotate(0 4 13)"><text x="4" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">7</text></g><g transform="translate(267.5 11) rotate(0 13.5 17)"><path d="M-1.119012787938118 0.13371343910694122 C4.075400396436454 0.49558123655617237, 11.398765607178213 -0.4119872181862593, 25.973924204707146 -1.7047145813703537 M-0.6647032722830772 0.10834362357854843 C7.580351366847754 -0.6938563064485788, 16.373356750607492 0.6282483860105277, 27.23837123066187 0.41767527908086777 M28.3364005535841 1.3911220580339432 C25.700903134196995 7.418628357350826, 26.377079682201146 15.988325208425522, 25.28534035384655 33.66422052681446 M26.697483398020267 -0.7788941636681557 C26.834217077344658 9.081689408421518, 27.71991038903594 19.884922821819785, 27.42170200496912 33.97748186439276 M26.138173148036003 32.75602884590626 C21.795315263420342 34.99750128798187, 14.314807842671868 35.69830075316131, -1.4479975253343582 33.71145458519459 M27.70106563717127 33.139371894299984 C20.027929151803257 34.21409246660769, 12.762606692314147 32.94612452723086, 0.8677662387490273 33.94411065429449 M0.4147229641675949 33.092203333973885 C-0.15331182584166525 25.155207307636736, 1.9159616459906101 12.2926283955574, 1.074203535914421 0.8788821250200272 M0.6763657107949257 34.84922578185797 C1.0809388418495656 22.24982251524925, -0.3463713864982128 11.475393308699129, -0.5540513023734093 -0.610416866838932" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(529.4999999999999 10) rotate(0 13.5 17)"><path d="M0.13371343910694122 -1.5185808688402176 C6.052536384016276 0.3618698029965162, 10.614624099433422 -0.8750090689212084, 25.295285418629646 -0.2775573283433914 M0.10834362357854843 -0.14494623988866806 C4.740829107910395 1.1022314206510782, 11.503708574175835 0.41784111417829994, 27.417675279080868 -0.396603487432003 M28.391122058033943 -1.1471366435289383 C25.455190823227166 8.209437681734563, 25.173339531570672 15.646135908365252, 26.66422052681446 33.589049860835075 M26.221105836331844 -0.00017442554235458374 C26.57254050388932 9.429433915019036, 27.87438915386796 17.509532062709333, 26.977481864392757 33.02707610279322 M25.756028845906258 34.26842074096203 C19.863080563396217 32.1446721727401, 12.489373613893985 32.4356558496505, -0.2885454148054123 33.62428192794323 M26.139371894299984 34.620709754526615 C19.568086694926023 35.13745561979711, 10.587644696235657 35.05705396078527, -0.055889345705509186 34.16539344936609 M-0.9077966660261154 33.74713425338268 C1.924854796975851 26.611946932971478, -0.1753863872587681 16.66528195142746, 0.8788821250200272 0.5190568417310715 M0.8492257818579674 34.97771606594324 C-0.3611650796234607 24.382633596658707, -0.05319765523076053 15.110404215753078, -0.610416866838932 0.5674208179116249" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(38 73.5) rotate(0 25.5 13)"><text x="25.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0x48</text></g><g transform="translate(127 75) rotate(0 23 13)"><text x="23" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0xc7</text></g><g transform="translate(210.5 75) rotate(0 26.5 13)"><text x="26.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0xc0</text></g><g transform="translate(294.75 75.75) rotate(0 125.5 13)"><text x="125.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0x64 0x00 0x00 0x00</text></g></svg>

This is how you read the table! Slowly, piece by piece, and with a nice cup of
tea to help you in trying times. Now that we've read the table, let's go on and
write some code.

### Encoding, programatically

While writing code, you will often need to reference *two more tables* than the
ones we have looked at so far. These tables are Table 2-2 "32-Bit Addressing
Forms with the ModR/M Byte" (page 532) and Table 2-3 "32-Bit Addressing Forms
with the SIB Byte" (page 533). Although the tables describe 32-bit quantities,
with the REX prefix all the Es get replaced with Rs and all of a sudden they
can describe 64-bit quantities.

These tables are super helpful when figuring out how to put together ModR/M and
SIB bytes.

Let's start the encoding process by revisiting `Emit_mov_reg_imm32`/`REX.W + C7
/0 id`:

```c
void Emit_mov_reg_imm32(Buffer *buf, Register dst, int32_t src) {
  // ...
}
```

Given a register `dst` and an immediate 32-bit integer `src`, we're going to
encode this instruction. Let's do all the steps in order.

#### REX prefix

Since the instruction calls for REX.W, we can keep the first line the same as
before:

```c
void Emit_mov_reg_imm32(Buffer *buf, Register dst, int32_t src) {
  Buffer_write8(buf, kRexPrefix);
  // ...
}
```

Nice.

#### Opcode

This opcode is `0xc7`, so we'll write that directly:

```c
void Emit_mov_reg_imm32(Buffer *buf, Register dst, int32_t src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0xc7);
  // ...
}
```

Also the same as before. Nice.

#### ModR/M byte

ModR/M bytes are where the code gets a little different. We want an abstraction
to build them for us, instead of manually slinging integers like some kind of
animal.

To do that, we should know how they are put together. ModR/M bytes are
comprised of:

* *mod* (high 2 bits), which describes what big row to use in the ModR/M table
* *reg* (middle 3 bits), which either describes the second register operand
  *or* an opcode extension (like `/0` above)
* *rm* (low 3 bits), which describes the first operand

This means we can write a function `modrm` that puts these values together for
us:

```c
byte modrm(byte mod, byte rm, byte reg) {
  return ((mod & 0x3) << 6) | ((reg & 0x7) << 3) | (rm & 0x7);
}
```

The order of the parameters is a little different than the order of the bits. I
did this because it looks a little more natural when calling the function from
its callers. Maybe I'll change it later because it's too confusing.

For this instruction, we're going to:

* pass `0b11` (3) as *mod*, because we want to move directly into a 64-bit
  register, as opposed to `[reg]`, which means that we want to dereference the
  value in the pointer
* pass the destination register `dst` as *rm*, since it's the first operand
* pass `0b000` (0) as *reg*, since the `/0` above told us to

That ends up looking like this:

```c
void Emit_mov_reg_imm32(Buffer *buf, Register dst, int32_t src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0xc7);
  Buffer_write8(buf, modrm(/*direct*/ 3, dst, 0));
  // ...
}
```

Which for the above instruction `mov rax, 100`, produces a *modrm* byte that
has this layout:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 379.5 138.5">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="379.5" height="138.5" fill="#ffffff"></rect><g transform="translate(102.5 39) rotate(0 39.5 27.5)"><path d="M1.4340841323137283 0.675150915980339 C21.45130690410733 0.32077685438096526, 45.628884290158744 0.5304769619554282, 80.57989378273486 -0.9472136050462723 M-0.3343488946557045 0.644506074488163 C28.808401323109862 0.5067852009087801, 56.29565685093402 0.303329037502408, 78.55183365195988 0.5622137561440468 M78.48981733620165 0.9726357907056808 C77.52915891073643 21.773218441754583, 79.68525012396275 38.36339765042067, 77.02986831963061 54.77365688979626 M78.09568168967961 -0.3491574749350548 C79.05909616835415 11.934856925159693, 78.82251555807888 23.479468554258347, 78.6352074369788 54.098190404474735 M79.0021698027849 55.73855023086071 C47.940980117768035 53.9483561591059, 21.384871609508984 56.55994225300849, 1.4916379004716873 53.853093668818474 M79.59806182235478 54.042226888239384 C47.98039643391965 53.78492393426597, 19.183310574293124 54.350007199570534, 0.025061629712581635 54.74992785602808 M0.4442860633134842 53.13256220519543 C0.9966684315353632 34.880078833550215, 1.0072213146835565 15.55684045702219, -1.4835279434919357 0.6226397007703781 M0.4791879877448082 55.88335642963648 C0.41228914074599743 39.37267915531993, -0.13116097636520863 25.529337391257283, 0.36373021453619003 -0.37881412357091904" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(195.5 39) rotate(0 39.5 27.5)"><path d="M-0.8444098979234695 -0.5101826637983322 C29.11412446424365 -2.5109387513250114, 58.144970227777954 -0.35484753809869285, 77.54094652831553 -1.9701316803693771 M-0.13902559131383896 -0.9043183103203773 C22.456787239760157 -0.5245804429799317, 46.01949612796306 -0.7611610532552002, 79.42496810108422 -0.364792563021183 M79.94102053344248 0.0021698027849197388 C80.15050815083085 10.098241101950409, 77.98861096836625 24.69939357787371, 80.18823914229868 56.49163790047169 M78.20512519031762 0.5980618223547935 C78.5054609607905 12.680129792541265, 78.87610910646616 27.58277729153633, 78.9779582992196 55.02506162971258 M78.34429459273814 55.444286063313484 C55.40813214257358 55.78601691566408, 36.15267953127621 55.79656979881227, 1.9997621029615402 53.516472056508064 M78.32055435329674 55.47918798774481 C53.723929611593476 55.62163573689759, 26.01656420826911 55.07818561978638, 0.45481476932764053 55.36373021453619 M0.9313302487134933 55.24243564903736 C-1.5336779270321133 42.527414698153734, -0.36107193566858775 26.974701486527916, -1.2866916209459305 -1.8912346810102463 M-0.18116583675146103 55.94389417022467 C0.9011098820716144 37.38249160721898, 0.08180136270821098 21.46149279177189, 0.00617227703332901 -0.05801532417535782" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(290.5 38) rotate(0 39.5 27.5)"><path d="M-0.5101826637983322 0.9726357907056808 C26.702013505250214 2.1955347903817892, 57.45786506980657 -1.1255115620046854, 77.02986831963061 -0.22634311020374298 M-0.9043183103203773 -0.3491574749350548 C16.376850462704894 0.5174369157105684, 32.69759290516376 0.5347983182221651, 78.6352074369788 -0.9018095955252647 M79.0021698027849 0.7385502308607101 C77.37894875667988 19.196232248097658, 80.44005400799213 42.427397541701794, 80.49163790047167 53.853093668818474 M79.59806182235478 -0.9577731117606163 C78.30603831894695 20.54521575942636, 79.86267822869121 42.24263975024224, 79.02506162971257 54.74992785602808 M79.44428606331347 53.13256220519543 C50.14665417000651 55.34253602065146, 20.393654234707355 56.74075846709311, -1.4835279434919357 55.62263970077038 M79.4791879877448 55.88335642963648 C58.00628122910856 53.798655783459544, 35.97089735865592 54.91805270843208, 0.36373021453619003 54.62118587642908 M0.24243564903736115 53.61121468245983 C1.6327842328697444 36.83489457890391, 0.49659334160387514 17.815456189215183, -1.8912346810102463 0.2107129544019699 M0.9438941702246666 55.71549091488123 C-0.024882521107792765 40.252372067421675, 1.1335792880505324 25.718551620841023, -0.05801532417535782 -0.4577132686972618" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(10 55.5) rotate(0 36 13)"><text x="36" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">ModR/M</text></g><g transform="translate(122.5 102.5) rotate(0 17.5 13)"><text x="17.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">mod</text></g><g transform="translate(223 101.5) rotate(0 16 13)"><text x="16" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">reg</text></g><g transform="translate(318 102.5) rotate(0 11 13)"><text x="11" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">rm</text></g><g transform="translate(135.5 42.5) rotate(0 5 18)"><text x="5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">11</text></g><g transform="translate(297.5 48.5) rotate(0 32.5 18)"><text x="32.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">000</text></g><g transform="translate(116 13) rotate(0 22.5 10.5)"><text x="22.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">direct</text></g><g transform="translate(219.5 11) rotate(0 10.5 10.5)"><text x="10.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">/0</text></g><g transform="translate(304.5 10) rotate(0 15.5 10.5)"><text x="15.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">RAX</text></g><g transform="translate(204.5 51) rotate(0 32.5 18)"><text x="32.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">000</text></g></svg>


I haven't put a datatype for *mod*s together because I don't know if I'd be
able to express it well. So for now I just added a comment.

#### Immediate value

Last, we have the immediate value. As I said above, all this entails is writing
out a 32-bit quantity as we have always done:

```c
void Emit_mov_reg_imm32(Buffer *buf, Register dst, int32_t src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0xc7);
  Buffer_write8(buf, modrm(/*direct*/ 3, dst, 0));
  Buffer_write32(buf, src);
}
```

And there you have it! It took us 2500 words to get us to these measly four
bytes. The real success is the friends we made along the way.

### Further instructions

"But Max," you say, "this produces literally the same output as before with all
cases! Why go to all this trouble? What gives?"

Well, dear reader, having a mod of 3 (direct) means that there is no
special-case escape hatch when `dst` is RSP. This is unlike the other mods,
where there's this `[--][--]` in the table where RSP should be. That funky
symbol indicates that there must be a Scale-Index-Base (SIB) byte following the
ModR/M byte. This means that the overall format for this instruction should
have the following layout:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 472.9166666666665 124.5">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="472.9166666666665" height="124.5" fill="#ffffff"></rect><g transform="translate(24 58) rotate(0 39.5 27.5)"><path d="M-0.211656853556633 -0.8879780322313309 C16.454499114304777 -1.2561685243993996, 30.229740165174 -0.46433035530149924, 79.96581478416918 0.8454466313123703 M0.05744936317205429 -0.8617903217673302 C18.509021282941102 0.974765554741025, 35.912764528393744 0.9925694621354342, 78.3458917364478 -0.45998992770910263 M78.05847759544848 -0.22799010574817657 C77.95287208221852 17.487797904759645, 79.6232607807964 32.364764504134655, 80.28204603493212 56.64415220916271 M78.35598733276127 0.8645397201180458 C79.737716018036 18.068197164684534, 78.57736068852245 37.45212957262993, 78.92887642234562 55.79378304630518 M78.23786802589892 54.127478167414665 C48.257336514443146 54.012860017195344, 22.324366648495186 53.58451386012137, 1.1095840483903885 55.73159985244274 M79.17633774131535 54.99911103397608 C58.1156358681619 54.06200413875282, 39.436304539442055 54.854695131108166, 0.3693669065833092 54.70994768291712 M1.9715339690446854 54.916219756007195 C-0.5013338711112738 31.742648761719465, 1.004961809888482 12.776154793798923, -1.328426644206047 -0.4825424700975418 M0.8639595732092857 55.19255838543177 C0.5481167893856763 41.39139608666301, 0.519856796786189 26.974122032523155, 0.5987596735358238 0.7282012477517128" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(44 74.5) rotate(0 19 13)"><text x="19" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">REX</text></g><g transform="translate(138 73) rotate(0 12 13)"><text x="12" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Op</text></g><g transform="translate(201 76) rotate(0 36 13)"><text x="36" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">ModR/M</text></g><g transform="translate(110.5 59.5) rotate(0 39.5 27.5)"><path d="M-1.8544457405805588 0.04965643584728241 C21.158301556855438 1.1386084159463643, 38.93931362479925 0.8431357940286397, 78.79540748894213 0.11489872634410858 M-0.06652209907770157 0.9117554202675819 C16.2377481944859 -1.166211622878909, 33.609912469983094 -0.22755505435168732, 78.7174189314246 -0.470761202275753 M79.35999412834643 1.2765694111585617 C79.92168752811848 17.517179418355227, 79.51092998646199 33.71291332691908, 77.24637384712695 53.711974665522575 M78.03647448867558 -0.3399571403861046 C79.03713282234965 22.04875150695443, 79.80968459732829 43.150449961423874, 79.2049598917365 54.61893401294947 M80.80693216621874 53.42259554564953 C59.85604528710245 55.277721825018524, 37.54939974099397 53.760111751928925, -1.4993608444929123 55.35267548263073 M79.38247492164372 55.446942664682865 C55.676389738172276 54.43680650405586, 32.49864775538443 55.35445172004402, 0.5368230566382408 55.98576698452234 M1.3501379042863846 55.50677780807018 C-1.2854832556098699 38.24785320088267, -0.7646306898444891 24.05245093256235, -0.9999020546674728 1.7279191464185715 M0.9575631842017174 55.53246460109949 C0.05655692629516129 38.169130127877, -1.5397725243121385 20.191148743033402, -0.21497008949518204 -0.8211900219321251" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(197.5 59.5) rotate(0 39.5 27.5)"><path d="M0.04965643584728241 0.9658147841691971 C26.174450968950985 -0.713153853043914, 51.207982684671876 0.5279135564714669, 79.1148987263441 -1.7235806435346603 M0.9117554202675819 -0.6541082635521889 C27.34309602901339 -0.12124798782169821, 56.08483855426311 -0.23002861030399802, 78.52923879772423 -0.11399505287408829 M80.27656941115855 1.2820460349321365 C81.17866980768738 13.767703425139189, 81.50137650705872 24.039203710854053, 77.71197466552256 56.72907944023609 M78.66004285961388 -0.07112357765436172 C79.33846764080225 18.28399219736457, 79.18519763462244 35.37008789181709, 78.61893401294945 54.56373908370733 M77.42259554564951 56.10958404839039 C61.962053722888214 54.770215469226244, 42.67489752024411 54.2143773611635, 0.3526754826307297 54.998222067952156 M79.44694266468285 55.36936690658331 C62.20905131474136 56.18675728030503, 46.62580016255378 55.83897824473679, 0.9857669845223427 54.9581098780036 M0.5067778080701828 53.67157335579395 C0.03776845596730716 38.121859807521105, 2.11197051666677 21.858965717256062, 1.7279191464185715 0.385116770863533 M0.5324646010994911 55.598759673535824 C0.35938919372856615 32.0804027505219, -0.05952107124030592 10.940974965691566, -0.8211900219321251 0.33645131438970566" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(10 16) rotate(0 13.5 17)"><path d="M0.8454466313123703 -1.4456599205732346 C6.146472259610892 -0.33497750692069533, 11.307895226776601 -1.853965639397502, 28.03875593841076 1.7879030257463455 M-0.45998992770910263 -0.17380044609308243 C8.399056973308326 -0.10597183741629124, 15.370019462704661 0.06261417828500271, 26.34480271488428 0.9718501791357994 M28.644152209162712 0.8712884932756424 C29.183875708431007 9.058363865315915, 25.928991465419532 23.353059476614, 27.39365963637829 32.344307616353035 M27.79378304630518 0.701428197324276 C27.524927612394094 7.128973153233528, 26.50334858521819 13.411765606701374, 26.24930963665247 33.42547085136175 M27.73159985244274 33.05647726356983 C15.674631354957818 32.65043300203979, 6.273958633840081 34.14801591448486, -1.822557881474495 33.30850334465504 M26.709947682917118 34.88460209220648 C18.494910610467194 34.63655212141573, 9.720402407646176 34.05783894278109, -0.07807888835668564 33.05398013442755 M-0.4825424700975418 33.192425921559334 C1.50550736322999 20.504863508045673, 1.6417669190466404 9.394647896289825, 1.9716463536024094 1.3411347419023514 M0.7282012477517128 33.002430222928524 C0.12825301840901376 20.329315084218976, -1.002227986305952 7.425021661818025, 0.8413969054818153 -0.9299754872918129" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(16 20) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0</text></g><g transform="translate(113 18) rotate(0 2 13)"><text x="2" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">1</text></g><g transform="translate(101.5 12) rotate(0 13.5 17)"><path d="M-0.2045925110578537 0.11489872634410858 C7.51777230873704 0.9645094471424818, 20.270608930289747 -0.20729068942368029, 28.823510840535164 -1.3082165271043777 M-0.28258106857538223 -0.470761202275753 C6.744032142311335 -0.784437278136611, 14.687904569506646 0.050757071152329414, 27.63828470557928 0.6410230174660683 M25.24637384712696 -1.2880253344774246 C28.87719848409295 13.3887183919549, 25.492426660209894 24.06306648850441, 26.32008571922779 33.85775284469128 M27.204959891736507 -0.3810659870505333 C26.802224670797585 12.148171994090081, 26.663956438452004 26.7011907979846, 26.211297772824764 34.554792024195194 M25.500639155507088 34.35267548263073 C17.910562267154454 32.071330738738176, 8.133183743059632 34.65883846350014, 0.8938853293657303 34.73873381316662 M27.53682305663824 34.98576698452234 C19.64125113412738 34.09137119434774, 11.42026264667511 34.844519034847615, 0.2533889040350914 33.33578667789698 M-0.9999020546674728 35.72791914641857 C0.5224043641984463 26.59196855276823, 1.4784223352372647 17.155770766735074, 1.0649292021989822 1.1975193470716476 M-0.21497008949518204 33.178809978067875 C0.6756250385940075 22.16551266312599, -0.5908017630875111 7.801484452188014, 0.6725170835852623 -0.927858255803585" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(182.5 12) rotate(0 13.5 17)"><path d="M0.11489872634410858 -1.7235806435346603 C7.187115045636893 1.815523014739156, 12.163674016296865 1.8511308295279743, 25.691783472895622 -0.9199798554182053 M-0.470761202275753 -0.11399505287408829 C6.97554151043296 1.0481470676511526, 15.441474655270579 0.7145815940946341, 27.64102301746607 0.822076104581356 M25.711974665522575 1.7290794402360916 C27.72802565082908 10.025498054921627, 25.40731499180198 22.682466596364975, 26.857752844691277 35.58756609261036 M26.618934012949467 -0.4362609162926674 C26.467084070295094 12.01032672226429, 28.121240516752003 24.38100951462984, 27.554792024195194 34.36579992622137 M27.35267548263073 33.998222067952156 C18.351197812706232 33.10608963064849, 14.112461231648922 34.691471615359184, 0.7387338131666183 33.419895365834236 M27.985766984522343 33.9581098780036 C16.433495462685823 33.19892235971987, 6.698217654228209 34.39833112932742, -0.6642133221030235 33.75872876495123 M1.7279191464185715 34.38511677086353 C1.7010642232000828 26.514010675251484, 1.6445442380011082 17.410681068897247, 1.1975193470716476 1.4564024955034256 M-0.8211900219321251 34.336451314389706 C0.7362379713356495 26.261761754751205, -0.9519059972465038 21.0559915676713, -0.927858255803585 -0.6458658948540688" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(188.5 16) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">2</text></g><g transform="translate(273 15) rotate(0 7 13)"><text x="7" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">3</text></g><g transform="translate(267.5 10) rotate(0 13.5 17)"><path d="M-0.13304419815540314 1.8235108405351639 C4.464949604123831 -1.1613467638939619, 11.198731370270252 0.7159663731604814, 26.434837862849236 -0.941522404551506 M0.1799970641732216 0.6382847055792809 C8.43323637470603 0.5596765562146901, 16.020070961117746 0.7210299059003591, 26.12318692356348 -0.6440126672387123 M25.07294897735119 -0.6799142807722092 C26.924674982875587 14.727001141011716, 28.469778532832862 27.559896177053453, 27.409919783473015 33.23786802589893 M27.90346608310938 -0.7887022271752357 C27.299557300657035 9.082512810826302, 26.273003908246757 17.040420658886433, 26.250319577753544 34.176337741315365 M27.764949843287468 34.89388532936573 C19.641134021431206 33.32654331736266, 12.574004600942132 35.16183374933898, 1.0736461132764816 35.971533969044685 M27.675068952143192 34.25338890403509 C18.348890007287263 33.50330340124667, 10.62241961956024 34.5404044315964, -0.4999510273337364 34.863959573209286 M1.9151263684034348 35.06492920219898 C0.8623394669592381 24.60170398503542, -2.3303194342553617 12.909184944629668, -0.4299401789903641 -1.6423800438642502 M-0.846747063100338 34.67251708358526 C-1.2139332036674022 22.010199636220932, -0.878685448616743 11.410649217665195, -0.43011512607336044 -0.08725068718194962" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(285.4722222222224 57.8055555555556) rotate(0 39.5 27.5)"><path d="M0.26801256835460663 1.2346870452165604 C20.537436150759458 -1.4341206260770558, 43.1872766032815 1.4325266174227, 80.1982145756483 -0.9842188805341721 M-0.7956205829977989 0.5988381132483482 C19.357714664191004 0.7705681084841489, 38.53092448413371 1.0855698346346616, 79.29294738918541 0.8634233698248863 M80.62868408858775 -1.7903597801923752 C80.0709334347397 18.784832131117582, 80.38085326887666 37.12731225043535, 77.93197874724864 56.546108439564705 M79.45927391201256 -0.3889932408928871 C80.3667128752917 17.82645144686103, 79.00279528610407 33.21184089779854, 79.5830973163247 55.690556310117245 M79.54421095550059 56.607032969594 C57.62367448285221 56.38987860761583, 32.28570331782102 53.58266720853746, -0.6861400157213211 54.335301116108894 M79.3177221789956 55.76730229705572 C62.384487191587674 54.720360609963535, 45.84661505818366 54.93796548552811, 0.9809514060616493 54.50532200187445 M1.252386137843132 56.93125982582569 C-0.08689453937113284 41.793003577739, 0.945223781093955 29.985512100160122, 1.2535262554883957 0.9658786803483963 M-0.31964101642370224 55.60849621146917 C1.1697504121810198 37.925931591540575, 0.10171600170433526 22.530010953545563, -0.823793075978756 0.6844294294714928" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(306.4722222222224 72.3055555555556) rotate(0 18.5 13)"><text x="18.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">SIB</text></g><g transform="translate(367.9722222222224 17.75) rotate(0 6 13)"><text x="6" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">4</text></g><g transform="translate(359.25 12.75) rotate(0 13.5 17)"><path d="M1.3603682965040207 -1.6619594544172287 C8.101639004796745 0.07049717254936697, 18.045592208206656 -1.688526970669627, 26.098248526453972 -0.4453795403242111 M0.7143386378884315 -0.15961048752069473 C9.005839052051307 0.6184564276784659, 19.39045622646809 -0.027631934061646435, 27.931782342493534 0.06545450538396835 M25.112214133143425 -1.3115790337324142 C27.721223888248204 7.148178671300412, 28.157791671603917 17.39670895934105, 26.482952639460564 35.606859400868416 M26.872767068445683 0.3391609415411949 C26.490773068517445 12.09199338257313, 26.735894785970448 23.769653399288657, 26.47995839267969 33.07157304137945 M26.788055941462517 35.24835033714771 C18.282967302948236 33.24988443188369, 10.307709597051144 34.727157896086574, 0.44741444289684296 35.142573073506355 M27.55955395847559 34.22912957519293 C17.668201983720063 34.0131201980263, 8.682955050468443 34.15830686070025, -0.7206067070364952 33.59364464133978 M-1.311813309788704 35.45972318947315 C-1.5292182503640652 19.584595020115373, 1.0318917693197727 9.93671599626541, -1.0361980944871902 1.6817810088396072 M-0.8559159263968468 34.082316897809505 C-0.2721802406013012 22.074972623586653, -0.27609721943736076 8.671655143797395, 0.4885343089699745 0.0396282896399498" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(372.13888888888914 58.91666666666674) rotate(0 39.5 27.5)"><path d="M0.9097743481397629 -0.2824409455060959 C29.08075623437762 -0.0795379921048881, 61.796217490732666 1.9367674545198676, 80.30115799605845 0.1976277381181717 M0.22230467945337296 0.8691818937659264 C22.748953448981045 1.1363844918459653, 44.15094554126262 0.937103991433978, 78.74239120632409 0.9659204706549644 M80.8468618839979 1.8700024634599686 C77.62429933287201 14.960775505751371, 79.47596721388398 33.02977425605059, 77.52540068328379 54.61638279259205 M79.86672554165123 -0.291378952562809 C79.74560787193475 11.441657211631536, 78.64401938430963 24.801669389009476, 79.40253625065087 55.82735516875982 M80.69036726653574 54.718322947621346 C60.30233010724186 52.781452589854595, 43.16092075556516 53.514524393901226, 1.9993229359388351 56.31744070351124 M79.87641892582177 54.6179683431983 C63.438107720762474 54.634116064980624, 45.000628119707095 53.5171262139827, 0.8071042075753212 54.727203868329525 M0.9280834645032883 54.516915038228035 C0.9788710322231055 38.7506509013474, 0.41211239956319334 25.026089034974575, -1.117407277226448 1.63332100212574 M-0.9729804024100304 54.26299526542425 C-0.18014220409095294 43.89328350499272, -0.7905350130051375 32.51724697649479, 0.5207923427224159 -0.8328244462609291" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(389.13888888888914 73.41666666666674) rotate(0 22.5 13)"><text x="22.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Disp</text></g><g transform="translate(435.9166666666665 12.75) rotate(0 13.5 17)"><path d="M-1.9783048182725906 1.2481171637773514 C5.538952442258597 0.23712667055428027, 11.645122666656972 0.8551624638587236, 28.500221773982048 1.2052518874406815 M-0.7637056335806847 -0.8346385732293129 C5.525140824168921 -0.35947101153433325, 11.796020057797433 0.6463647600263357, 26.767130710184574 -0.8334886804223061 M28.837551638484 0.45514126121997833 C25.312507166713477 11.402979229390622, 26.312200560420752 24.07367181181908, 27.038291975855827 34.39196653664112 M26.979050494730473 0.7464311346411705 C28.0202788887918 10.509414055943488, 26.739086824506522 23.3356522873044, 27.811987973749638 33.47148086875677 M26.96754078567028 35.16126509010792 C18.724022052437064 34.6485569434613, 12.990314720571039 33.25582003168762, 0.5931315869092941 33.05483169853687 M27.730877973139286 34.2106414064765 C19.06708992794156 33.104861247316, 12.151447939872739 34.72081969954073, 0.6903794780373573 33.30778434127569 M-1.1161694079637527 35.38650818169117 C-0.10551591023802759 21.62171588689089, 0.6251650322973727 13.924504768848418, 1.8087835758924484 -0.20800809562206268 M0.9002240672707558 34.71595122665167 C-0.4455855779349804 24.581983083486556, 0.6506485052406787 15.987344469130036, 0.8498149886727333 -0.5806817784905434" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(442.4166666666665 16.75) rotate(0 7 13)"><text x="7" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">5</text></g></svg>

If you're trying to encode `mov [rsp-8], rax`, for example, the values should
look like this:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 475.5277777777774 165">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="475.5277777777774" height="165" fill="#ffffff"></rect><g transform="translate(24 58) rotate(0 39.5 27.5)"><path d="M-0.9266414195299149 -1.907962128520012 C25.020240473002193 -2.218284475430846, 46.58435564190149 -2.3352035161107776, 77.26505045592783 0.2505580931901932 M0.4766293540596962 -0.62445018440485 C17.68952830955386 0.40917568914592284, 37.92498738467693 -0.07908338792622072, 79.12231860309838 0.44129016250371933 M79.20858149230479 0.43721504509449005 C79.84434154964983 13.86689830943942, 77.21619680859148 28.537990875542164, 78.61955742537974 54.65648050606251 M79.86121592670678 -0.2460019364953041 C77.80013445131479 21.22563674673438, 78.17490247003732 43.57156589627266, 79.86515865474938 55.07342340797186 M77.52219490706919 55.870359137654305 C54.65745665505527 55.53924108825624, 26.393350116908543 54.28850246749818, -0.11365838348865509 56.596170619130135 M79.43993244320153 54.978965781629086 C52.98701869621871 54.5945573849231, 25.29152835011481 54.07481942601502, -0.6390334591269493 54.21589448302984 M1.267616793513298 56.13023968040943 C1.646718868240714 37.186983961611986, -1.2211414489895107 15.767364107072353, -0.5093040019273758 -0.613477036356926 M0.9806011691689491 55.59903695434332 C0.3084158379584551 41.746727008372545, 0.9990865666419269 27.776031747460365, 0.9166270270943642 0.5032248720526695" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(47 127.5) rotate(0 19 13)"><text x="19" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">REX</text></g><g transform="translate(138 126) rotate(0 12 13)"><text x="12" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Op</text></g><g transform="translate(204 129) rotate(0 36 13)"><text x="36" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">ModR/M</text></g><g transform="translate(110.5 59.5) rotate(0 39.5 27.5)"><path d="M-1.9359368830919266 -1.6092837303876877 C14.4286000482738 0.8400421456247567, 31.016815568506715 -0.11095282278954999, 80.21159605681895 0.9532587081193924 M0.8762279525399208 0.39949705451726913 C18.889162146300077 -0.26003718145191645, 37.05112130343914 -0.6342368102818725, 79.52715096622704 0.10429074615240097 M77.1792970150709 0.8462144881486893 C78.84160390831529 17.35882188007236, 81.19255462624132 33.80326826125384, 77.12130932509898 56.72243185341358 M78.61529145389794 -0.26622889190912247 C79.44744654409585 15.220412757247688, 78.8036140989512 29.931442528963093, 79.01655779033898 54.2610974535346 M77.29030422866343 54.27542181313038 C51.748423022776834 56.804003990516065, 25.476118843257417 56.877392567023634, -0.7080673724412918 55.879864886403084 M78.63198099285363 54.35450603812933 C54.82713686600326 54.1165472406894, 32.3749309837818 55.178642167523506, 0.8268035426735878 55.63380839675665 M-1.0682472735643387 53.63585777580738 C-1.0041975889354944 34.77836384251714, -1.644915572181344 15.072435460984707, -0.5699910670518875 1.9612023383378983 M0.8034938350319862 54.450910829007626 C0.8545743186026812 35.708521623164415, -0.8942538540810346 16.229094758629792, -0.12585201114416122 0.9975700601935387" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(197.5 59.5) rotate(0 39.5 27.5)"><path d="M-1.6092837303876877 -1.7349495440721512 C26.952930224686856 -0.5455885473638775, 52.70430738776921 1.9762911256402729, 79.95325870811938 -1.2489003688097 M0.39949705451726913 0.12231860309839249 C17.545964051038023 -1.1747858654707668, 34.27643831074237 -0.16506911627948262, 79.10429074615239 0.21860752254724503 M79.84621448814868 -0.3804425746202469 C78.66225828789173 20.690972972661257, 77.40436329506336 35.56223898380995, 80.72243185341357 54.50799612700939 M78.73377110809086 0.8651586547493935 C78.69213005192576 12.544205103069544, 78.25617047436533 24.6623155772686, 78.26109745353459 55.43517956882715 M78.27542181313036 54.886341616511345 C52.52773246094583 55.07662620104849, 24.53268287926911 53.616602797880766, 0.8798648864030838 54.95793156325817 M78.35450603812932 54.36096654087305 C49.32365884408354 55.15185531787574, 21.49351813197135 55.536068527027965, 0.633808396756649 55.565119840204716 M-1.3641422241926193 54.490695998072624 C-0.9218155052512884 32.40104214474559, -1.0195847656577826 11.53213719278574, 1.9612023383378983 1.1980739086866379 M-0.5490891709923744 55.916627027094364 C0.456933270022273 37.04727176949382, 0.7722096543759107 20.63309381902218, 0.9975700601935387 -0.29562439769506454" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(10 16) rotate(0 13.5 17)"><path d="M-1.3102836161851883 -0.7004368752241135 C7.139063020795584 0.9194333655387164, 10.606033559143544 -1.7035281556099653, 28.775512263178825 1.7524559050798416 M-0.4825657829642296 0.06709053367376328 C9.705793013423682 -0.014857597723603233, 18.5758916169405 0.2845725341886282, 27.01050505787134 -0.9103514924645424 M28.97050814330578 -1.6014144867658615 C25.05663408741355 13.360996483266355, 26.44332088932395 21.758176130056384, 25.61347870528698 33.230582907795906 M27.22132620960474 -0.3625361695885658 C27.310711732953788 8.555919221043588, 27.729333511441947 19.142610390484336, 27.263080216944218 33.14515211433172 M27.751956030726433 35.6695591956377 C19.170113179832697 35.09534791998565, 12.714292667806149 35.52997306875884, -0.25151200592517853 33.26396198570728 M27.442590333521366 34.27798940986395 C21.4696372397244 34.422099907174704, 14.850787234306335 34.688098032251, 0.5606153979897499 33.46587636321783 M-1.1500219851732254 33.28875370323658 C-0.4834093867242336 28.080244119465352, 1.2846555890142919 18.463729774951936, 0.16833309829235077 1.6069876700639725 M-0.8322011455893517 34.81850125640631 C-0.437505200356245 26.664473241567613, -0.6072775869071483 17.24850522428751, 0.4287453666329384 -0.032407261431217194" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(16 20) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0</text></g><g transform="translate(113 18) rotate(0 2 13)"><text x="2" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">1</text></g><g transform="translate(101.5 12) rotate(0 13.5 17)"><path d="M0.9532587081193924 -1.2489003688097 C4.661414305120707 1.6119467955082656, 14.414690141379834 0.6354286413639784, 27.244637206196785 0.8825803250074387 M0.10429074615240097 0.21860752254724503 C7.200793264061213 -0.13182570300996305, 12.683793279528619 0.2807764831930399, 26.809778712689877 -0.17175974696874619 M28.722431853413582 -0.4920038729906082 C25.20880640760064 12.163342548906805, 25.95834244504571 26.567269903421405, 28.730317309498787 34.14684681594372 M26.261097453534603 0.43517956882715225 C27.429704557806254 11.215589329600334, 26.02188981667161 21.542729131877422, 26.943170808255672 34.79808530956507 M27.879864886403084 33.95793156325817 C19.19934939369559 33.65289889879525, 8.033680702745912 32.61342298097909, -1.2780669182538986 32.431788966059685 M27.63380839675665 34.565119840204716 C18.604812621325255 34.783852354511616, 7.875888562202455 33.54116584442556, -0.2546520009636879 33.69326148182154 M1.9612023383378983 35.19807390868664 C0.3465580831468106 25.923370473086834, 1.7278995405137538 16.411896407604218, 1.8332540541887283 1.006449744105339 M0.9975700601935387 33.704375602304935 C-0.36359156563878064 27.058229261636733, -0.3106976886093617 18.928051243722436, 0.3273942694067955 -0.351221464574337" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(182.5 12) rotate(0 13.5 17)"><path d="M-1.2489003688097 -1.6697028130292892 C8.929922481626273 1.6237659794837236, 15.107814545929433 0.115947280600667, 27.88258032500744 -0.9651315659284592 M0.21860752254724503 0.4037208780646324 C8.291649498790504 -0.9385099939256907, 16.98539612591267 -0.21837978877127173, 26.828240253031254 0.9852540716528893 M26.507996127009392 -1.5189531296491623 C25.294101290553808 6.708178280293942, 26.148164801448583 16.68550805449486, 27.146846815943718 34.44265241920948 M27.435179568827152 0.5529668554663658 C27.268709865659474 8.112529137730599, 26.643340555280446 17.877924855053426, 27.798085309565067 34.375978015363216 M26.95793156325817 35.31449003517628 C16.394583079963923 33.3827437453717, 5.001202248036861 32.84071484141052, -1.5682110339403152 34.88518066704273 M27.565119840204716 34.89980652183294 C18.71004399135709 33.637004630342126, 8.616786074638366 33.91647626616061, -0.306738518178463 33.42498900741339 M1.1980739086866379 34.22564621269703 C0.2652315796911716 26.616106374561788, -1.0012798605859279 17.851491463184356, 1.006449744105339 -1.6644022911787033 M-0.29562439769506454 33.914698861539364 C0.4715350504219532 20.98468846678734, -0.2881268624961376 8.361585725843906, -0.351221464574337 0.18868353217840195" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(188.5 16) rotate(0 7.5 13)"><text x="7.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">2</text></g><g transform="translate(273 15) rotate(0 7 13)"><text x="7" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">3</text></g><g transform="translate(267.5 10) rotate(0 13.5 17)"><path d="M0.7989941090345383 0.24463720619678497 C6.728481527417898 -1.2017131131142378, 11.825983472168446 0.8177203852683306, 27.208581492304802 0.43721504509449005 M0.42310724407434464 -0.19022128731012344 C9.01828662380576 1.2310489746183158, 17.579385498166083 -0.6935504344850778, 27.86121592670679 -0.2460019364953041 M26.467542216181755 1.730317309498787 C26.911138195842504 8.060432098805904, 26.039219040721655 15.268674939870834, 25.522194907069206 34.870359137654305 M26.63771090656519 -0.056829191744327545 C27.887532583326102 12.456065323948861, 27.924226871579886 23.806140930950644, 27.439932443201542 33.978965781629086 M25.70901207625866 32.7219330817461 C15.55722741857171 34.785815535113215, 7.806855724751948 35.55424195341766, 1.267616793513298 35.13023968040943 M26.31792888790369 33.74534799903631 C16.163783872872592 33.2807756254822, 5.585421633720397 33.57079108454287, 0.9806011691689491 34.59903695434332 M-1.0981783419847488 35.83325405418873 C0.9778331173956394 21.751999147236347, 1.6083858861029148 12.581098854541779, 1.9951401203870773 -0.5912487953901291 M-0.33091654628515244 34.327394269406796 C-0.49699488922953605 24.278707402944562, -0.20299164101481437 14.199525846540926, 0.2276068702340126 0.8112330660223961" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(38 72.5) rotate(0 25.5 13)"><text x="25.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0x48</text></g><g transform="translate(125 74) rotate(0 25 13)"><text x="25" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0x89</text></g><g transform="translate(212 74) rotate(0 25 13)"><text x="25" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0x44</text></g><g transform="translate(288.0833333333335 58.30555555555554) rotate(0 39.5 27.5)"><path d="M-0.29279451072216034 -1.483827069401741 C24.67649298980832 1.9116385539621112, 51.29490463584661 1.5841224750131366, 79.78033752739428 -0.32721514999866486 M0.9313540682196617 -0.6077729687094688 C27.831130362302062 -0.34773232333362114, 55.748995950818056 1.5332155049592255, 78.70140960067509 0.7428341880440712 M80.64814682304858 1.6952953785657883 C80.58963305614887 13.892241884022953, 78.03025490902363 27.069702915847305, 77.90116472542284 53.12246088683605 M79.58369757980107 -0.33412542194128036 C78.80360711701213 20.46599117293954, 80.01326216347515 39.825777262449265, 78.6572427973151 55.767069198191166 M77.53057070076464 56.178296610713005 C63.19729522988199 54.38578070677817, 44.26412046700715 54.45722092665732, 0.47177524864673615 56.063027426600456 M78.89017774909733 55.770126678049564 C50.567083879560215 55.09529642753303, 20.785028523206698 53.55093602828681, 0.3997810110449791 54.82918415218592 M1.655746653676033 55.54671959578991 C-1.6575097467750313 36.82269994542003, -0.7188715364784003 14.312593258917332, -1.6284363716840744 1.747902438044548 M0.11812856048345566 55.183743096888065 C-0.2030535835772752 35.66940717026591, 0.4482671122998 16.324604019522667, 0.28229572623968124 0.6970013156533241" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(312.4166666666665 127.25) rotate(0 18.5 13)"><text x="18.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">SIB</text></g><g transform="translate(370.5833333333335 18.25) rotate(0 6 13)"><text x="6" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">4</text></g><g transform="translate(361.86111111111086 13.25) rotate(0 13.5 17)"><path d="M1.3170290440320969 -1.6910155266523361 C8.694240375608207 1.0255605847388507, 15.082239671051504 1.242717471793294, 25.052879855036736 -1.436517521739006 M-0.9151567444205284 0.46879007667303085 C11.580447068065405 -0.3501678041368723, 21.972146156430245 -0.7024863294512034, 26.97529873996973 -0.3545229211449623 M27.97224096953869 -0.9561593979597092 C28.51790130123496 11.903014324605465, 25.410661101192236 27.31316766142845, 28.352180525660515 33.10615415871143 M27.36495289951563 0.6414125189185143 C26.51009807214141 11.841814568638803, 27.653466554731132 23.566409428417685, 26.221572019159794 34.502936862409115 M25.988460585474968 33.98092146217823 C19.943630359321833 34.681794171854854, 15.830486534535885 35.60692835383117, -1.7848743945360184 32.328101351857185 M27.755696393549442 34.22061302512884 C18.40785607174039 34.61169756628573, 11.222224307060241 34.76012672163546, 0.6529420390725136 34.165168069303036 M1.3378558605909348 33.64024658501148 C-1.7500372420251369 19.35679431706667, 1.6549601067602635 8.969048225879668, -1.214241936802864 -0.6725314110517502 M-0.08447899669408798 34.11435057967901 C-0.24564096733927726 23.68065862059593, 0.634528662711382 13.747233690321444, -0.03308143466711044 -0.8739328160881996" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(374.75 59.41666666666674) rotate(0 39.5 27.5)"><path d="M-1.6910155266523361 0.9895129650831223 C18.619220603257414 -0.847441622391343, 36.67526056617498 -2.4673466173559424, 77.56348247826098 1.8627081364393234 M0.46879007667303085 0.9657910838723183 C18.6000031478703 1.4658080161362885, 37.14627816975116 0.6982725680619477, 78.64547707885502 0.8240734115242958 M78.04384060204028 1.2297010868787766 C78.34204988144337 19.28452317789197, 80.75035361908375 43.67630510777235, 78.10615415871142 56.167395159602165 M79.6414125189185 -0.37629928439855576 C78.34470940716564 15.429379377514126, 77.88473249562084 28.546192377805713, 79.5029368624091 54.26528535038233 M78.98092146217822 54.05990080535412 C51.117503636330355 55.66346935786307, 23.688366205990306 52.8155675367266, -1.6718986481428146 54.780355498194695 M79.22061302512883 54.21133599430323 C49.61578025445341 55.426184303089975, 19.980208653211584 56.24994218997657, 0.16516806930303574 55.82787332683802 M-0.35975341498851776 53.34290508925915 C-1.2713786747306584 38.7444235496223, 1.3556445453315975 17.778800286352634, -0.6725314110517502 0.23625712096691132 M0.1143505796790123 54.816831685602665 C0.5776292901486159 38.186414282768965, 1.2458414655178784 19.94574449956417, -0.8739328160881996 0.38903460651636124" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(388.4166666666665 123.91666666666686) rotate(0 22.5 13)"><text x="22.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">Disp</text></g><g transform="translate(438.5277777777774 13.25) rotate(0 13.5 17)"><path d="M0.7803375273942947 -0.32721514999866486 C10.87548362389207 -2.080704395249486, 18.319460897147657 1.729123886153102, 25.784454062581062 0.3820548504590988 M-0.29859039932489395 0.7428341880440712 C4.978167865425348 -0.2854648526757956, 10.903630658984184 0.5633098188787699, 27.847647689282894 0.8016093745827675 M25.90116472542286 -1.877539113163948 C28.14692136541009 13.204990173876286, 25.943607061058284 24.873014456033708, 26.33174915611744 32.863514944911 M26.65724279731512 0.7670691981911659 C26.415346142202615 10.66241187751293, 27.72101711884141 22.1469650670886, 27.589148305356503 34.77784786373377 M27.471775248646736 35.063027426600456 C21.66248764023185 32.08821221418679, 11.859257771074772 33.6534421069175, 1.5402533560991287 35.569752261042595 M27.39978101104498 33.82918415218592 C17.407829903811216 34.44000275753439, 6.884407544136046 34.61493404529989, 0.2733597978949547 33.350804187357426 M-1.6284363716840744 35.74790243804455 C1.0597449289262295 20.311403100192546, -0.6113733305037021 9.287547194957732, 0.3674861937761307 -1.0739402323961258 M0.28229572623968124 34.697001315653324 C0.9116287045180798 24.05414715409279, -0.9128120131790638 14.56349178403616, -0.9105088487267494 0.8273631110787392" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(445.0277777777774 17.25) rotate(0 7 13)"><text x="7" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">5</text></g><g transform="translate(301.0833333333335 72.80555555555554) rotate(0 26.5 13)"><text x="26.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0x24</text></g><g transform="translate(389.75 73.91666666666674) rotate(0 24.5 13)"><text x="24.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0xf8</text></g></svg>

This is where an instruction like `Emit_store_reg_indirect` (`mov [REG+disp],
src`) goes horribly awry with the homebrew encoding scheme I cooked up. When
the `dst` in that instruction is RSP, it's expected that the next byte is the
SIB. And when you output other data instead (say, an immediate 8-bit
displacement), you get really funky addressing modes. Like what the heck is
this?

```
mov qword [rsp + rax*2 - 8], rax
```

This is actual disassembled assembly that I got from running my binary code
through `rasm2`. Our compiler *definitely* does not emit anything that
complicated, which is how I found out things were wrong.

Okay, so it's wrong. We can't just blindly multiply and add things. So what do
we do?

#### The SIB byte

Take a look at Table 2-2 (page 532) again. See that trying to use RSP with any
sort of displacement requires the SIB.

Now take a look at Table 2-3 (page 533) again. We'll use this to put together
the SIB.

We know from Section 2.1.3 that the SIB, like the ModR/M, is comprised of three
fields:

* *scale* (high 2 bits), specifies the scale factor
* *index* (middle 3 bits), specifies the register number of the index register
* *base* (low 3 bits), specifies the register number of the base register

Intel's language is not so clear and is kind of circular. Let's take a look at
sample instruction to clear things up:

```
mov [base + index*scale + disp], src
```

Note that while *index* and *base* refer to registers, *scale* refers to one
of 1, 2, 4, or 8, and *disp* is some immediate value.

This is a compact way of specifying a memory offset. It's convenient for
reading from and writing to arrays and structs. It's also going to be necessary
for us if we want to write to and read from random offsets from the stack
pointer, RSP.

So let's try and encode that `Emit_store_reg_indirect`.

#### Encoding the indirect mov

Let's start by going back to the table enumerating all the kinds of MOV
instructions (page 1209). The specific opcode we're looking for is `REX.W + 89
/r`, or `MOV r/m64, r64`.

We already know what REX.W means:

```c
void Emit_store_reg_indirect(Buffer *buf, Indirect dst, Register src) {
  Buffer_write8(buf, kRexPrefix);
  // ...
}
```

And next up is the literal `0x89`, so we can write that straight out:

```c
void Emit_store_reg_indirect(Buffer *buf, Indirect dst, Register src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0x89);
  // ...
}
```

So far, so good. Looking familiar. Now that we have both the instruction prefix
and the opcode, it's time to write the ModR/M byte. Our ModR/M will contain
the following information:

* *mod* of 1, since we want an 8-bit displacement
* *reg* of whatever register the second operand is, since we have two register
  operands (the opcode field says `/r`)
* *rm* of whatever register the first operand is

Alright, let's put that together with our handy-dandy ModR/M function.

```c
void Emit_store_reg_indirect(Buffer *buf, Indirect dst, Register src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0x89);
  // Wrong!
  Buffer_write8(buf, modrm(/*disp8*/ 1, dst.reg, src));
  // ...
}
```

But no, this is wrong. As it turns out, you still have do this special thing
when `dst.reg` is RSP, as I keep mentioning. In that case, `rm` must be the
special *none* value (as specified by the table). Then you also have to write a
SIB byte.

```c
void Emit_store_reg_indirect(Buffer *buf, Indirect dst, Register src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0x89);
  if (dst.reg == kRsp) {
    Buffer_write8(buf, modrm(/*disp8*/ 1, kIndexNone, src));
    // ...
  } else {
    Buffer_write8(buf, modrm(/*disp8*/ 1, dst.reg, src));
  }
  // ...
}
```

> Astute readers will know that `kRsp` and `kIndexNone` have the same integral
> value of 4. I don't know if this was intentional on the part of the Intel
> designers. Maybe it's supposed to be like that so encoding is easier and
> doesn't require a special case for both ModR/M and SIB. Maybe it's
> coincidental. Either way, I found it very subtle and wanted to call it out
> explicitly.

For an instruction like `mov [rsp-8], rax`, our *modrm* byte will look like
this:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 379.5 138.5">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="379.5" height="138.5" fill="#ffffff"></rect><g transform="translate(102.5 39) rotate(0 39.5 27.5)"><path d="M-1.8630583733320236 0.30926088988780975 C16.143922293931247 -2.1593383661657573, 29.724831794202327 0.6919480451196433, 79.54817791283129 1.096030279994011 M-0.6386699452996254 0.7630704417824745 C17.85999536588788 -1.6137530647963283, 35.73466012775898 -0.3707904659956691, 78.40886666625737 -0.5971530899405479 M78.88400478661059 0.795054480433464 C77.33277825973927 22.905330825597048, 80.40270309112965 40.27444200962782, 78.43118162453173 53.56819777190685 M79.00831773132084 -0.4947914108633995 C78.57177430279552 20.60498133674264, 77.72239309437572 40.679950922727585, 78.95162918418644 54.092349864542484 M77.03641767799853 54.917734667658806 C49.789683049172154 57.51678089655936, 17.805353815853586 54.921320481672886, 1.6965858489274979 54.89551357924938 M79.83532097190617 54.77863488346338 C54.457323070615516 53.98197890453041, 29.50952383875846 53.675609838292004, -0.17739937454462051 55.75479135662317 M-0.38580016791820526 56.040094420313835 C-1.726383176073432 33.981617610901594, 0.2810111377388239 17.477874077856534, -1.0574648827314377 -0.8873543292284012 M0.500298760831356 54.92148409038782 C0.22272931151092057 42.63442377373576, 0.39216219000518326 30.90117357671261, -0.7343225255608559 -0.4826313480734825" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(195.5 39) rotate(0 39.5 27.5)"><path d="M0.30926088988780975 0.33241577446460724 C16.273050355166195 -1.1622731872648002, 37.35553794056177 1.2840859702974556, 80.096030279994 -1.5223544090986252 M0.7630704417824745 0.1732952818274498 C16.63630677387118 0.8658092164248227, 35.37902705371379 -0.08658407695591464, 78.40284691005944 0.8231954798102379 M79.79505448043345 -1.9251749962568283 C80.53937587477266 20.224282395094633, 76.88091191984712 37.59024674445391, 77.56819777190684 56.47464771568775 M78.50520858913659 -0.07619378715753555 C78.91737024299799 12.054105903953314, 78.43705861084162 25.910990983247757, 78.09234986454247 55.820311330258846 M78.91773466765879 55.97014255821705 C62.990466589480626 53.39065781675279, 42.63404506891965 55.92097083173692, -0.10448642075061798 55.33598394691944 M78.77863488346337 55.48445966094732 C61.44194168224929 56.22370058722794, 44.22522071003913 55.48250419326126, 0.7547913566231728 55.5335755571723 M1.0400944203138351 53.39776296913624 C-1.4422922406345606 37.66369583085179, 1.4886297907680273 18.45961221307516, -0.8873543292284012 -1.4808261841535568 M-0.0785159096121788 54.958527110517025 C-0.03340405635535715 41.26998199895024, 0.6610737401992083 26.549721494317055, -0.4826313480734825 0.9021971449255943" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(290.5 38) rotate(0 39.5 27.5)"><path d="M0.33241577446460724 -1.9581508189439774 C23.813694227486845 0.7709775408357382, 51.971928857266896 0.9738722284883261, 77.47764559090136 -1.5696815997362137 M0.1732952818274498 -0.8634509071707726 C31.564281535893677 -0.2233139573782681, 61.8149098187685 -1.1999787389487027, 79.82319547981022 0.46900591999292374 M77.07482500374316 1.8777556866407394 C80.11285115145145 11.335493613034487, 78.39928294084964 24.80060153454542, 80.47464771568774 53.71988396346569 M78.92380621284245 0.049700118601322174 C78.07899975664913 14.74608973041177, 78.95620393641292 29.445752352476124, 79.82031133025883 54.248222924768925 M79.97014255821703 56.751427695155144 C46.812740819901215 54.1234724739939, 17.98952182084321 54.86301877297461, 0.3359839469194412 53.28110174834728 M79.48445966094731 54.35229358822107 C59.56694385632871 53.87104607991874, 38.82889429926871 55.579912914559245, 0.5335755571722984 55.22572026401758 M-1.602237030863762 53.416283175349236 C0.5112523291260005 41.26145104691386, -0.9513698365539311 23.941137351095673, -1.4808261841535568 -0.9607352763414383 M-0.041472889482975006 55.06215176731348 C-0.14720432944595818 38.30107132717967, -1.0094868440181017 19.606252178549767, 0.9021971449255943 -0.041617296636104584" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(10 55.5) rotate(0 36 13)"><text x="36" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">ModR/M</text></g><g transform="translate(122.5 102.5) rotate(0 17.5 13)"><text x="17.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">mod</text></g><g transform="translate(223 101.5) rotate(0 16 13)"><text x="16" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">reg</text></g><g transform="translate(318 102.5) rotate(0 11 13)"><text x="11" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">rm</text></g><g transform="translate(135.5 42.5) rotate(0 5 18)"><text x="5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">11</text></g><g transform="translate(306 48.5) rotate(0 24 18)"><text x="24" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">100</text></g><g transform="translate(119 13) rotate(0 19.5 10.5)"><text x="19.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">disp8</text></g><g transform="translate(214.5 11) rotate(0 15.5 10.5)"><text x="15.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">RAX</text></g><g transform="translate(303.5 10) rotate(0 16.5 10.5)"><text x="16.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">none</text></g><g transform="translate(204.5 51) rotate(0 32.5 18)"><text x="32.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">000</text></g></svg>

Let's go ahead and write that SIB byte. I made a `sib` helper function like
`modrm`, with two small differences: the parameters are in order of low to
high bit, and the parameters have their own special types instead of just being
`byte`s.

```c
typedef enum {
  Scale1 = 0,
  Scale2,
  Scale4,
  Scale8,
} Scale;

typedef enum {
  kIndexRax = 0,
  kIndexRcx,
  kIndexRdx,
  kIndexRbx,
  kIndexNone,
  kIndexRbp,
  kIndexRsi,
  kIndexRdi
} Index;

byte sib(Register base, Index index, Scale scale) {
  return ((scale & 0x3) << 6) | ((index & 0x7) << 3) | (base & 0x7);
}
```

I made all these datatypes to help readability, but you don't have to use them
if you don't want to. The `Index` one is the only one that has a small gotcha:
where `kIndexRsp` should be is `kIndexNone` because you can't use RSP as an
index register.

Let's use this function to write a SIB byte in `Emit_store_reg_indirect`:

```c
void Emit_store_reg_indirect(Buffer *buf, Indirect dst, Register src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0x89);
  if (dst.reg == kRsp) {
    Buffer_write8(buf, modrm(/*disp8*/ 1, kIndexNone, src));
    Buffer_write8(buf, sib(kRsp, kIndexNone, Scale1));
  } else {
    Buffer_write8(buf, modrm(/*disp8*/ 1, dst.reg, src));
  }
  // ...
}
```

If you get it right, the SIB byte will have the following layout:

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 335.5 138.5">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style>
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/FG_Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
  </defs>
  <rect x="0" y="0" width="335.5" height="138.5" fill="#ffffff"></rect><g transform="translate(10 51.75) rotate(0 18.5 13)"><text x="18.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">SIB</text></g><g transform="translate(58.5 39) rotate(0 39.5 27.5)"><path d="M-1.0398114174604416 -0.7369322329759598 C29.652781976014374 1.1447416194528341, 60.049187014997 1.7837782748788595, 77.770381167531 1.0693378895521164 M-0.9780354276299477 -0.7481271252036095 C14.992142248898741 -0.7262752997130156, 31.265565469861023 1.0249117863923312, 78.14419295638798 -0.6618021950125694 M79.3432685881853 1.9180202931165695 C79.41139304302631 17.91898863390088, 80.11593091152606 35.97078400105238, 80.63803453743456 56.56515650451183 M78.34581687301396 -0.07372274249792099 C78.51525701172649 15.735512886196375, 79.770688425377 30.256761759519577, 78.4316911920905 54.165533401072025 M78.78501863777636 53.634664103388786 C61.41478981301187 55.515771513357755, 38.999349196255196 55.350639467611906, -0.1773412674665451 54.55967812240124 M78.57771208137272 54.739879943430424 C50.215295930951825 56.16359251670539, 22.929074543714513 56.21603387527168, 0.3848006948828697 55.714342691004276 M-0.6632917374372482 53.24454216659069 C-1.465600910410285 36.55402509495616, 1.690078315511346 19.647733487188816, 0.9536482840776443 1.5563207119703293 M-0.3900158181786537 54.546440698206425 C-0.24826518483459958 35.341467183083296, -0.1527306217700244 15.208370193839066, 0.9817929491400719 0.1274479404091835" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(151.5 39) rotate(0 39.5 27.5)"><path d="M-0.7369322329759598 -0.45581798255443573 C26.23876418992877 0.24271260775625697, 51.906400920450686 -0.8188933225721122, 80.0693378895521 -1.9907334297895432 M-0.7481271252036095 -0.84446070343256 C27.89849659129977 0.3650075530260799, 58.51079566180706 -0.0831590557843449, 78.33819780498742 0.14624454826116562 M80.91802029311656 0.7575690299272537 C79.45357992388307 14.500347029417753, 80.20103027559816 27.714514799416065, 80.56515650451182 54.66962929069996 M78.92627725750206 -0.6705031171441078 C78.7712130498141 18.94252958521247, 77.70098137371241 36.14689376950264, 78.16553340107201 54.46280314773321 M77.63466410338877 56.870934680104256 C47.51906389668582 53.82672129236162, 15.985052435100066 54.737741094455124, -0.4403218775987625 56.22264643013477 M78.73987994343041 54.74474932998419 C62.54988297596573 55.654373886063695, 45.35729964375495 55.05119323916733, 0.7143426910042763 55.0360374674201 M-1.7554578334093094 53.29492349922657 C-1.9215464148670436 42.34535862877965, -2.1296319518238307 27.743160091340542, 1.5563207119703293 1.1570875197649002 M-0.4535593017935753 55.23894312232733 C-0.008737150952219941 33.96239461377263, -0.459843460842967 13.237626805901527, 0.1274479404091835 0.039531491696834564" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(246.5 38) rotate(0 39.5 27.5)"><path d="M-0.45581798255443573 1.2101641148328781 C24.18621205165982 2.1402890022844074, 47.478831075131886 1.3604261215776203, 77.00926657021044 1.3066106289625168 M-0.84446070343256 -0.962615393102169 C20.928958631306884 1.379592121914029, 41.81739108860492 -0.07078176610171805, 79.14624454826115 -0.6294108852744102 M79.75756902992724 0.6146436184644699 C80.55650576017796 16.251457024365664, 80.73243339918552 31.343882612884045, 78.66962929069994 55.675491377711296 M78.32949688285588 0.1440323367714882 C79.22512757666408 11.845607791095972, 78.07189047224819 24.709147661924362, 78.4628031477332 55.97074422985315 M80.87093468010424 54.88794331252575 C47.93335692211985 54.18350358761847, 18.86609471589327 54.020370443239806, 1.2226464301347733 53.36582903563976 M78.74474932998417 55.7949076667428 C52.601132842153305 55.64185418061912, 24.611103695631023 55.50884784631431, 0.036037467420101166 54.56458983570337 M-1.7050765007734299 53.252231165766716 C1.6330079529434443 34.806369822472334, 1.1360535118728876 20.08076909929514, 1.1570875197649002 1.7716665714979172 M0.23894312232732773 55.02345786243677 C0.5489863853901624 37.75040141865611, 1.1963016491383314 21.483547672629356, 0.039531491696834564 0.22463569790124893" stroke="#000000" stroke-width="1" fill="none"></path></g><g transform="translate(71 102.5) rotate(0 25 13)"><text x="25" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">scale</text></g><g transform="translate(169.5 101.5) rotate(0 25.5 13)"><text x="25.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">index</text></g><g transform="translate(262.5 102.5) rotate(0 22.5 13)"><text x="22.5" y="18" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">base</text></g><g transform="translate(77.22222222222217 49.16666666666663) rotate(0 21.5 18)"><text x="21.5" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">00</text></g><g transform="translate(262 48.5) rotate(0 24 18)"><text x="24" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">100</text></g><g transform="translate(88.5 13) rotate(0 6 10.5)"><text x="6" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">0</text></g><g transform="translate(169.5 11) rotate(0 16.5 10.5)"><text x="16.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">none</text></g><g transform="translate(260.5 10) rotate(0 15.5 10.5)"><text x="15.5" y="15" font-family="Virgil, Segoe UI Emoji" font-size="16px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">RSP</text></g><g transform="translate(169 51) rotate(0 24 18)"><text x="24" y="25" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#000000" text-anchor="middle" style="white-space: pre;" direction="ltr">100</text></g></svg>

This is a very verbose way of saying `[rsp+DISP]`, but it'll do. All that's
left now is to encode that displacement. To do that, we'll just write it out:

```c
void Emit_store_reg_indirect(Buffer *buf, Indirect dst, Register src) {
  Buffer_write8(buf, kRexPrefix);
  Buffer_write8(buf, 0x89);
  if (dst.reg == kRsp) {
    Buffer_write8(buf, modrm(/*disp8*/ 1, kIndexNone, src));
    Buffer_write8(buf, sib(kRsp, kIndexNone, Scale1));
  } else {
    Buffer_write8(buf, modrm(/*disp8*/ 1, dst.reg, src));
  }
  Buffer_write8(buf, disp8(indirect.disp));
}
```

Very nice. Now it's your turn to go forth and convert the rest of the assembly
functions in your compiler! I found it very helpful to extract the
`modrm`/`sib`/`disp8` calls into a helper function, because they're mostly the
same and very repetitive.

### What did we learn?

This was a very long post. The longest post in the whole series so far, even.
We should probably have some concrete takeaways.

If you read this post through, you should have gleaned some facts and lessons
about:

* Intel x86-64 instruction encoding terminology and details, and
* how to read dense tables in the Intel Developers Manual
* maybe some third thing, too, I dunno --- this post was kind of a lot

Hopefully you enjoyed it. I'm going to go try and get a good night's sleep.
Until next time, when we'll implement procedure calls!

Here's a fun composite diagram for the road:

<object type="image/svg+xml" data="/assets/img/composite-instruction-encoding.svg">
  This is a composite of all the instruction encoding diagrams present in the
  post. If you're seeing this text, it means your browser cannot render SVG.
</object>

{% include compiling_a_lisp_toc.md %}

<br />
<hr style="width: 100px;" />
<!-- Footnotes -->

[^1]: If you are an avid reader of this blog (Do those people exist? Please
      reach out to me. I would love to chat.), you may notice that Tom gets
      pulled into shenanigans a lot. This is because Tom is the best debugger I
      have ever encountered, he's good at reverse engineering, and he knows a
      lot about low-level things. I think right now he's working on improving
      open-source tooling for a RISC-V board for fun. But also he's very kind
      and helpful and generally interested in whatever ridiculous situation
      I've gotten myself into. Maybe I should add a list of the Tom Chronicles
      somewhere on this website. Anyway, everyone needs a Tom.
